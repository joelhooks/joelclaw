Used skill: `inngest-flow-control` (to apply the correct Inngest flow-control primitives and config shapes).

Implemented all FLOW-1 changes in `createFunction()` configs:

- `src/inngest/functions/agent-loop/plan.ts:188`
  - Set `concurrency` to keyed array with `key: "event.data.loopId"` and `limit: 1`.
- `src/inngest/functions/agent-loop/implement.ts:337`
  - Set `concurrency` to keyed array with `key: "event.data.loopId"` and `limit: 1`.
- `src/inngest/functions/observe.ts:170`
  - Added `throttle: { limit: 4, period: "60s" }`.
- `src/inngest/functions/backfill-observe.ts:35`
  - Added `singleton: { key: '"backfill"', mode: "skip" }`.
- `src/inngest/functions/content-sync.ts:45`
  - Added `debounce: { period: "5s", key: '"vault-sync"' }`.
- `src/inngest/functions/agent-dispatch.ts:43`
  - Added `throttle: { limit: 3, period: "60s" }`.

Validation:

- Ran `bunx tsc --noEmit` successfully (exit code `0`).


--- STDERR ---
OpenAI Codex v0.101.0 (research preview)
--------
workdir: /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus
model: gpt-5.3-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: none
reasoning summaries: auto
session id: 019c6bff-d4d6-7723-a68b-245c8b2975be
--------
user


## Project File Listing

docker
prd-v3-recovery.json
prd-adr-0010.json
progress.txt
node_modules
prd-retro.json
bun.lock
README.md
package.json
scripts
prd-harden.json
tsconfig.json
docker-compose.yml
prd-v2.json
index.ts
CONTINUATION.md
prd-0026.json
prd.json
start.sh
CLAUDE.md
prd-cli-migration.json
src
CONTINUATION-ADR.md

# src/ files:
src/inngest/client.ts
src/serve.ts

## Project Instructions (CLAUDE.md)


## Agent Loop Architecture (ADR-0015)

This project runs automated coding loops with 5 separated roles:
- **Planner**: generates PRD from goal, picks next story
- **Test Writer**: writes acceptance tests BEFORE implementation (TDD)
- **Implementor**: writes code to pass the tests
- **Reviewer**: evaluates implementation with 4 questions (no test writing)
- **Judge**: mechanical gates + reviewer notes + LLM verdict

When working as an implementor: implement the story, don't write tests.
When working as a test writer: write tests from acceptance criteria only, don't read implementation.
Tests should verify observable behavior and public API — NOT internal structure.
Do NOT use source code string matching (indexOf, regex on source) to verify behavior.
Commit nothing — the harness handles git.

## Bun Runtime

Default to using Bun instead of Node.js.

- Use `bun <file>` instead of `node <file>` or `ts-node <file>`
- Use `bun test` instead of `jest` or `vitest`
- Use `bun build <file.html|file.ts|file.css>` instead of `webpack` or `esbuild`
- Use `bun install` instead of `npm install` or `yarn install` or `pnpm install`
- Use `bun run <script>` instead of `npm run <script>` or `yarn run <script>` or `pnpm run <script>`
- Use `bunx <package> <command>` instead of `npx <package> <command>`
- Bun automatically loads .env, so don't use dotenv.

## APIs

- `Bun.serve()` supports WebSockets, HTTPS, and routes. Don't use `express`.
- `bun:sqlite` for SQLite. Don't use `better-sqlite3`.
- `Bun.redis` for Redis. Don't use `ioredis`.
- `Bun.sql` for Postgres. Don't use `pg` or `postgres.js`.
- `WebSocket` is built-in. Don't use `ws`.
- Prefer `Bun.file` over `node:fs`'s readFile/writeFile
- Bun.$`ls` instead of execa.

## Testing

Use `bun test` to run tests.

```ts#index.test.ts
import { test, expect } from "bun:test";

test("hello world", () => {
  expect(1).toBe(1);
});
```

## Frontend

Use HTML imports with `Bun.serve()`. Don't use `vite`. HTML imports fully support React, C

---

## Story: Add flow control to loop functions and non-loop functions (FLOW-1)

Apply Inngest flow control patterns from the inngest-flow-control skill to make functions more resilient:

1. **plan.ts**: Add `concurrency: [{ key: 'event.data.loopId', limit: 1 }]` — only one plan per loop at a time, prevents duplicate planning.

2. **implement.ts**: Add `concurrency: [{ key: 'event.data.loopId', limit: 1 }]` — only one implement per loop.

3. **observe.ts** (memory): Add `throttle: { limit: 4, period: '60s' }` — LLM calls to pi should be throttled during rapid session activity.

4. **backfill-observe.ts**: Add `singleton: { key: '"backfill"', mode: 'skip' }` — only one backfill should run at a time, skip if already running.

5. **content-sync.ts**: Add `debounce: { period: '5s', key: '"vault-sync"' }` — fswatch fires multiple events per save burst, debounce so one git commit per burst.

6. **agent-dispatch.ts**: Add `throttle: { limit: 3, period: '60s' }` — don't stampede background agents.

For each function, add the flow control config to the first argument of createFunction().

## Acceptance Criteria
- plan.ts has concurrency keyed by loopId with limit 1
- implement.ts has concurrency keyed by loopId with limit 1
- observe.ts has throttle: { limit: 4, period: '60s' }
- backfill-observe.ts has singleton config
- content-sync.ts has debounce: { period: '5s', key: '"vault-sync"' }
- agent-dispatch.ts has throttle: { limit: 3, period: '60s' }
- TypeScript compiles (bunx tsc --noEmit)

## Instructions
Implement the story above. Do NOT write tests — a separate reviewer will handle testing.
Make clean, focused changes. Commit nothing — the harness handles git.
If your changes break existing tests (not just the ones for this story), fix those tests to match the new interface. Changing a type or adding a required field means updating all consumers.
mcp startup: no servers
2026-02-17T14:27:34.329682Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a38-72b9-7fd3-aae0-de7058d752e1
2026-02-17T14:27:34.457816Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5eca-bff9-7772-83bf-5daab07b9959
2026-02-17T14:27:34.556875Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5ffd-d51d-7a13-b1fa-342be02f164b
2026-02-17T14:27:34.694003Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6275-d69e-7b53-bb28-583bfe07e70c
2026-02-17T14:27:34.729872Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6946-d832-73b3-bade-761321c88a0a
2026-02-17T14:27:34.789690Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5d40-288c-78b2-af66-36e0fae54073
2026-02-17T14:27:34.872826Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-25bc-7141-bf68-7df6c001174c
2026-02-17T14:27:34.945680Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a5b-ba72-7f61-8273-d02deacae15e
2026-02-17T14:27:35.006470Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6482-5bab-7e53-bc62-5239d048a3c8
2026-02-17T14:27:35.054156Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a51-1205-7a00-bbdb-509c1624de3d
2026-02-17T14:27:35.119032Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a59-ea9c-73e1-b537-9ad62ea24fd1
2026-02-17T14:27:35.152086Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6485-58f0-7261-8508-37f3fb9356dd
2026-02-17T14:27:35.175729Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c695b-193b-7040-9529-153a24848595
2026-02-17T14:27:35.204239Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6031-b7fb-7120-85b5-8abf34324910
2026-02-17T14:27:35.289466Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fe2-872d-7e93-87a3-71d37d75a127
2026-02-17T14:27:35.334631Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a5d-a9a0-7003-8868-edeb59f5a8e9
2026-02-17T14:27:35.360627Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a4f-9a4d-7c13-aeef-771e0c9a7900
2026-02-17T14:27:35.423194Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5e50-6bc5-7861-a0a0-f77d68ec073f
2026-02-17T14:27:35.528750Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6022-8a12-7ba0-b7e8-9c265e8ec17e
2026-02-17T14:27:35.562041Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fbb-e145-7c40-9913-218548629e57
2026-02-17T14:27:35.590265Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5e21-7a30-7ed1-b686-e02ac2da8157
2026-02-17T14:27:35.669772Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c647c-8066-7eb1-8782-06a844370303
2026-02-17T14:27:35.731412Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-24ce-70e2-a3a9-72ea76928828
2026-02-17T14:27:35.864136Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a58-df8a-7560-894e-8c41ec0bc9ec
2026-02-17T14:27:35.933962Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-ca0f-7153-9527-6336e87fc2d0
2026-02-17T14:27:35.975303Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fed-5e04-78c0-9a4e-9fddc7af084e

thinking
**Planning parallel file inspection**
codex
Implementing FLOW-1 by locating each target Inngest function and then patching only the `createFunction()` config blocks with the specified flow-control settings. I’ll verify with a TypeScript compile check afterward.
exec
/bin/zsh -lc "rg -n \"createFunction\\(\" src index.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-busexec
/bin/zsh -lc 'rg --files' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 52ms:
src/inngest/functions/embed.ts:19:export const embedText = inngest.createFunction(
src/inngest/functions/transcript-process.ts:19:export const transcriptProcess = inngest.createFunction(
src/inngest/functions/content-sync.ts:40:export const contentSync = inngest.createFunction(
src/inngest/functions/video-download.ts:33:export const videoDownload = inngest.createFunction(
src/inngest/functions/discovery-capture.ts:14:export const discoveryCapture = inngest.createFunction(
src/inngest/functions/promote.ts:574:  inngest.createFunction(
src/inngest/functions/summarize.ts:36:export const summarize = inngest.createFunction(
src/inngest/functions/observe.ts:166:export const observeSessionFunction = inngest.createFunction(
src/inngest/functions/backfill-observe.ts:29:export const backfillObserve = inngest.createFunction(
src/inngest/functions/reflect.ts:271:export const reflect = inngest.createFunction(
src/inngest/functions/system-logger.ts:10:export const systemLogger = inngest.createFunction(
src/inngest/functions/agent-dispatch.ts:37:export const agentDispatch = inngest.createFunction(
src/inngest/functions/agent-loop/plan.ts:178:export const agentLoopPlan = inngest.createFunction(
src/inngest/functions/agent-loop/test-writer.ts:134:export const agentLoopTestWriter = inngest.createFunction(
src/inngest/functions/agent-loop/judge.ts:255:export const agentLoopJudge = inngest.createFunction(
src/inngest/functions/agent-loop/implement.ts:327:export const agentLoopImplement = inngest.createFunction(
src/inngest/functions/agent-loop/review.ts:304:export const agentLoopReview = inngest.createFunction(
src/inngest/functions/agent-loop/complete.ts:9:export const agentLoopComplete = inngest.createFunction(
src/inngest/functions/agent-loop/retro.ts:233:export const agentLoopRetro = inngest.createFunction(
 succeeded in 51ms:
CONTINUATION-ADR.md
src/serve.ts
src/inngest/functions/flow-control.acceptance.test.ts
src/inngest/functions/send-1-step-send-event.test.ts
src/inngest/functions/embed.ts
src/inngest/functions/transcript-process.ts
src/inngest/functions/content-sync.ts
src/inngest/functions/index.ts
src/inngest/functions/video-download.ts
src/inngest/functions/promote.test.ts
src/inngest/functions/send-2-step-send-event.test.ts
src/inngest/functions/discovery-capture.ts
src/inngest/functions/promote.ts
src/inngest/functions/summarize.ts
src/inngest/functions/reflect.test.ts
src/inngest/functions/observe.ts
src/inngest/functions/promote-integration.test.ts
src/inngest/functions/vault-sync.ts
src/inngest/functions/observe-parser.ts
src/inngest/functions/reflect-prompt.ts

thinking
**Planning multi-file inspection**
codex
I found all six target files. Next I’m inspecting their current `createFunction()` configs so I can apply minimal, type-safe edits.
exec
/bin/zsh -lc "sed -n '130,230p' src/inngest/functions/observe.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-busexec
/bin/zsh -lc "sed -n '300,390p' src/inngest/functions/agent-loop/implement.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-busexec
/bin/zsh -lc "sed -n '150,240p' src/inngest/functions/agent-loop/plan.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 51ms:
      // No remote — fall through to host-mode fallback
      repoUrl = null;
    }

    if (repoUrl) {
      const branch = branchName ?? `agent-loop/${loopId}`;
      const result = await spawnInContainer(
        tool as "codex" | "claude" | "pi",
        prompt,
        repoUrl,
        branch,
        loopId,
        "impl"
      );

      await Bun.write(Bun.file(outPath), result.output);
      return result.exitCode;
    }
  }

 succeeded in 51ms:
function assertRequiredStringField(
  payload: Record<string, unknown>,
  fieldName: "sessionId" | "dedupeKey" | "trigger" | "messages"
) {
  const value = payload[fieldName];
  if (typeof value !== "string" || value.trim().length === 0) {
    throw new NonRetriableError(`Missing required session field: ${fieldName}`);
  }
}

function validateObserveInput(eventName: string, data: unknown): ObserveInput {
  if (!data || typeof data !== "object") {
    throw new Error("Invalid event data: expected object payload");
  }

  const payload = data as Record<string, unknown>;
  assertRequiredStringField(payload, "sessionId");
  assertRequiredStringField(payload, "dedupeKey");
  assertRequiredStringField(payload, "trigger");
  assertRequiredStringField(payload, "messages");
 succeeded in 51ms:
    typecheckOk = false;
    typecheckOutput = e?.stdout?.toString() ?? e?.message ?? "typecheck failed";
  }

  let testsOk = true;
  let testOutput = "";
  try {
    const test = await $`cd ${project} && bun test 2>&1`.quiet();
    testsOk = test.exitCode === 0;
    testOutput = test.text().trim();
  } catch (e: any) {
    testsOk = false;
    testOutput = e?.stdout?.toString() ?? e?.message ?? "tests failed";
  }

  return {
    passed: typecheckOk && testsOk,
    typecheckOutput,
    testOutput,
  };
exec
/bin/zsh -lc "sed -n '1,140p' src/inngest/functions/backfill-observe.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-busexec
/bin/zsh -lc "sed -n '1,140p' src/inngest/functions/content-sync.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-busexec
/bin/zsh -lc "sed -n '1,140p' src/inngest/functions/agent-dispatch.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 50ms:
import { inngest } from "../client";
import { readdirSync, readFileSync } from "node:fs";
import { join, basename } from "node:path";
import { createHash } from "node:crypto";
import Redis from "ioredis";

const PI_SESSIONS_DIR =
  process.env.HOME + "/.pi/agent/sessions/--Users-joel--";

const REDIS_KEY = "memory:backfill:processed"; // SET of processed session IDs
const REDIS_PROGRESS_KEY = "memory:backfill:progress"; // HASH: total, processed, skipped, last_session

let redis: Redis | null = null;
function getRedis(): Redis {
  if (!redis) redis = new Redis({ host: "localhost", port: 6379 });
  return redis;
}

/**
 * Backfill observations from historical pi session transcripts.
 succeeded in 52ms:
import { inngest } from "../client";
import { syncFiles, commitAndPush, type SyncResult } from "./vault-sync";

/**
 * Content directories to sync from Vault → website.
 * Add new entries here as content types grow.
 */
const CONTENT_DIRS = [
  {
    name: "adrs",
    source: "/Users/joel/Vault/docs/decisions/",
    dest: "/Users/joel/Code/joelhooks/joelclaw/apps/web/content/adrs/",
    skipFiles: ["readme.md"],
  },
  {
    name: "discoveries",
    source: "/Users/joel/Vault/Resources/discoveries/",
    dest: "/Users/joel/Code/joelhooks/joelclaw/apps/web/content/discoveries/",
    skipFiles: [],
  },
 succeeded in 53ms:
import { inngest } from "../client";
import { NonRetriableError } from "inngest";
import { execSync } from "node:child_process";
import { writeFileSync, mkdirSync } from "node:fs";
import { join } from "node:path";

const INBOX_DIR = join(
  process.env.HOME || "/Users/joel",
  ".joelclaw",
  "workspace",
  "inbox"
);

type InboxResult = {
  requestId: string;
  sessionId?: string;
  status: "completed" | "failed";
  task: string;
  tool: string;
  result?: string;

thinking
**Planning multi-file patch application**
codex
I’ve confirmed the current configs. I’m now patching the six `createFunction()` definitions exactly per the story (including switching the two loop functions to `loopId`-keyed concurrency).
file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -187,6 +187,8 @@
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
apply_patch(auto_approved=true) exited 0 in 20ms:
Success. Updated the following files:
M src/inngest/functions/agent-loop/plan.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {

file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -336,6 +336,8 @@
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
apply_patch(auto_approved=true) exited 0 in 28ms:
Success. Updated the following files:
M src/inngest/functions/agent-loop/implement.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {

file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/observe.ts
@@ -169,2 +169,3 @@
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
apply_patch(auto_approved=true) exited 0 in 37ms:
Success. Updated the following files:
M src/inngest/functions/observe.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -34,2 +34,3 @@
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
apply_patch(auto_approved=true) exited 0 in 40ms:
Success. Updated the following files:
M src/inngest/functions/backfill-observe.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -44,2 +44,3 @@
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
apply_patch(auto_approved=true) exited 0 in 58ms:
Success. Updated the following files:
M src/inngest/functions/content-sync.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -42,2 +42,3 @@
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
apply_patch(auto_approved=true) exited 0 in 75ms:
Success. Updated the following files:
M src/inngest/functions/agent-dispatch.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },


thinking
**Running compilation check**
codex
Edits are in place across all six files. I’m running the required TypeScript compile check now (`bunx tsc --noEmit`) to confirm everything passes.
exec
/bin/zsh -lc 'bunx tsc --noEmit' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 3.66s:

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },


thinking
**Verifying exact string patterns**
exec
/bin/zsh -lc 'rg -n "concurrency|throttle|singleton|debounce" src/inngest/functions/agent-loop/plan.ts src/inngest/functions/agent-loop/implement.ts src/inngest/functions/observe.ts src/inngest/functions/backfill-observe.ts src/inngest/functions/content-sync.ts src/inngest/functions/agent-dispatch.ts' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 141ms:
src/inngest/functions/content-sync.ts:44:    concurrency: { limit: 1, key: "content-sync" },
src/inngest/functions/content-sync.ts:45:    debounce: { period: "5s", key: '"vault-sync"' },
src/inngest/functions/observe.ts:170:    throttle: { limit: 4, period: "60s" },
src/inngest/functions/agent-loop/implement.ts:337:    concurrency: [
src/inngest/functions/backfill-observe.ts:35:    singleton: { key: '"backfill"', mode: "skip" },
src/inngest/functions/backfill-observe.ts:253:        await step.sleep(`throttle-${sid}`, `${sleepSeconds}s`);
src/inngest/functions/agent-dispatch.ts:43:    throttle: { limit: 3, period: "60s" },
src/inngest/functions/agent-loop/plan.ts:188:    concurrency: [
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },


thinking
**Confirming skill usage and documentation**
codex
I also need to align with your project’s skill-routing rule, so I’m quickly checking the `inngest-flow-control` skill doc to ensure the config shapes match its guidance exactly.
exec
/bin/zsh -lc "sed -n '1,220p' /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/.agents/skills/inngest-flow-control/SKILL.md" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 51ms:
---
name: inngest-flow-control
description: Configure Inngest flow control for functions. Covers concurrency limits with keys, throttling, rate limiting, debounce, priority, singleton, and event batching.
---

# Inngest Flow Control

Master Inngest flow control mechanisms to manage resources, prevent overloading systems, and ensure application reliability. This skill covers all flow control options with prescriptive guidance on when and how to use each.

> **These skills are focused on TypeScript.** For Python or Go, refer to the [Inngest documentation](https://www.inngest.com/llms.txt) for language-specific guidance. Core concepts apply across all languages.

## Quick Decision Guide

- **"Limit how many run at once"** → Concurrency
- **"Spread runs over time"** → Throttling
- **"Block after N runs in a period"** → Rate Limiting
- **"Wait for activity to stop, then run once"** → Debounce
- **"Only one run at a time for this key"** → Singleton
- **"Process events in groups"** → Batching
- **"Some runs are more important"** → Priority
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },


thinking
**Reviewing recent changes**
exec
/bin/zsh -lc 'git diff -- src/inngest/functions/agent-loop/plan.ts src/inngest/functions/agent-loop/implement.ts src/inngest/functions/observe.ts src/inngest/functions/backfill-observe.ts src/inngest/functions/content-sync.ts src/inngest/functions/agent-dispatch.ts' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 52ms:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a..a34f8a4 100644
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@ export const agentDispatch = inngest.createFunction(
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830..157267e 100644
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@ export const agentLoopImplement = inngest.createFunction(
         if: "event.data.loopId == async.data.loopId",
       },
     ],
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

codex
Used skill: `inngest-flow-control` (to apply the correct Inngest flow-control primitives and config shapes).

Implemented all FLOW-1 changes in `createFunction()` configs:

- `src/inngest/functions/agent-loop/plan.ts:188`
  - Set `concurrency` to keyed array with `key: "event.data.loopId"` and `limit: 1`.
- `src/inngest/functions/agent-loop/implement.ts:337`
  - Set `concurrency` to keyed array with `key: "event.data.loopId"` and `limit: 1`.
- `src/inngest/functions/observe.ts:170`
  - Added `throttle: { limit: 4, period: "60s" }`.
- `src/inngest/functions/backfill-observe.ts:35`
  - Added `singleton: { key: '"backfill"', mode: "skip" }`.
- `src/inngest/functions/content-sync.ts:45`
  - Added `debounce: { period: "5s", key: '"vault-sync"' }`.
- `src/inngest/functions/agent-dispatch.ts:43`
  - Added `throttle: { limit: 3, period: "60s" }`.

Validation:

- Ran `bunx tsc --noEmit` successfully (exit code `0`).
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-dispatch.ts b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
index be4b03a503828f3f75eacad3de9183594995785b..a34f8a475dee3277c0913d7de0bdb5a4c46099b6
--- a/packages/system-bus/src/inngest/functions/agent-dispatch.ts
+++ b/packages/system-bus/src/inngest/functions/agent-dispatch.ts
@@ -40,6 +40,7 @@
     name: "Background Agent Dispatch",
     retries: 1,
     cancelOn: [{ event: "system/agent.cancelled", match: "data.requestId" }],
+    throttle: { limit: 3, period: "60s" },
   },
   { event: "system/agent.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
index 7616830a783a95d7ea5996cc09eea2e3d3f050de..157267ece7340301776d9d031512dfb0d874c66a
--- a/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/implement.ts
@@ -334,10 +334,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.tests.written" }, { event: "agent/loop.story.retried" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
index b1009e36de1d22ab1736e75b085bf1280e5bd70c..0673cd2fa9a0da405dab2048a187cbfa6e8fffcf
--- a/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/plan.ts
@@ -185,10 +185,12 @@
         if: "event.data.loopId == async.data.loopId",
       },
     ],
-    concurrency: {
-      key: "event.data.project",
-      limit: 1,
-    },
+    concurrency: [
+      {
+        key: "event.data.loopId",
+        limit: 1,
+      },
+    ],
   },
   [{ event: "agent/loop.started" }, { event: "agent/loop.story.passed" }, { event: "agent/loop.story.failed" }],
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/backfill-observe.ts b/packages/system-bus/src/inngest/functions/backfill-observe.ts
index 94e3e48bbdac3468c7ac8b72f3f622ac9ef60a92..3bd9812c98180e156d4226e01652117fe511d17a
--- a/packages/system-bus/src/inngest/functions/backfill-observe.ts
+++ b/packages/system-bus/src/inngest/functions/backfill-observe.ts
@@ -32,6 +32,7 @@
     name: "Backfill Observations from Transcripts",
     retries: 2,
     cancelOn: [{ event: "memory/backfill.cancelled" }],
+    singleton: { key: '"backfill"', mode: "skip" },
   },
   { event: "memory/backfill.requested" },
   async ({ event, step }) => {
diff --git a/packages/system-bus/src/inngest/functions/content-sync.ts b/packages/system-bus/src/inngest/functions/content-sync.ts
index 1a5a459f66ddc505d20f3ba0470742ecbec9ab06..9a7c00d96ec9f0bebd2989291f97f2431b732bdb
--- a/packages/system-bus/src/inngest/functions/content-sync.ts
+++ b/packages/system-bus/src/inngest/functions/content-sync.ts
@@ -42,6 +42,7 @@
     id: "system/content-sync",
     retries: 1,
     concurrency: { limit: 1, key: "content-sync" },
+    debounce: { period: "5s", key: '"vault-sync"' },
   },
   [
     { cron: "0 * * * *" },
diff --git a/packages/system-bus/src/inngest/functions/observe.ts b/packages/system-bus/src/inngest/functions/observe.ts
index 14bcfbf2b749e4128df4a7d65224e80c33d7cf96..e9548f77ab739271a383538b3bfe01487d22aad6
--- a/packages/system-bus/src/inngest/functions/observe.ts
+++ b/packages/system-bus/src/inngest/functions/observe.ts
@@ -167,6 +167,7 @@
   {
     id: "memory/observe-session",
     name: "Observe Session",
+    throttle: { limit: 4, period: "60s" },
   },
   [
     { event: "memory/session.compaction.pending" },

tokens used
46,505
