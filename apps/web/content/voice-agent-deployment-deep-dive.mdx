---
title: "Voice Agent Deployment: Phone Calls with My AI Assistant"
date: "2026-02-20T14:00:00"
description: "How I set up bidirectional voice conversations with my AI assistant using LiveKit, SIP trunks, and a distributed network. The complete topology and what actually works."
tags: ["voice", "livekit", "sip", "infrastructure"]
---

After months of terminal sessions, my AI assistant can now talk. Real voice, real phone calls, real conversations. This is how the voice infrastructure works.

## The Architecture

[ADR-0043](/adrs/0043-agent-voice-conversations) laid out the vision: self-hosted voice conversations via LiveKit. No cloud dependencies. Full control over the stack. Here's what got deployed.

### Network Topology

The system spans three nodes:

```
Primary (Mac Mini) ←──────────→ Edge (DigitalOcean)
    │                              │
    │ LiveKit Server               │ SIP Gateway
    │ Voice Agent                  │ Public IP
    │ k8s cluster                  │
    │                              ↓
    └───────────────────────────→ Telnyx SIP
                                   Phone Network
```

**Primary node** runs the core infrastructure:
- LiveKit server on k8s (ports 7880/7881)
- Python voice agent with function tools
- Connects via Tailscale mesh network

**Edge node** handles public connectivity:
- LiveKit SIP service in Docker
- Public IP for SIP registration
- Routes calls to primary via Tailscale

This split exists because SIP requires UDP on port 5060 and ports 10000-20000 for RTP media. Tailscale Funnel only supports TCP on specific ports. The edge node provides the public face while keeping the core system private.

### Voice Pipeline

```
Incoming call → Telnyx → Edge SIP → LiveKit room → Voice agent dispatched
                                                    │
                                                    ├─ Deepgram STT
                                                    ├─ Claude reasoning
                                                    ├─ Function tools
                                                    └─ ElevenLabs TTS
```

The agent runs as a Python process using `livekit-agents` framework. Key configuration:

```python
# Voice parameters tuned for phone quality
vad = silero.VAD.load(
    min_speech_duration=0.2,      # Quick response
    min_silence_duration=0.7,     # Natural pauses
    activation_threshold=0.85     # Filter background noise
)

# Pre-warm for instant responses
prewarm_fn = lambda: JobProcess(
    initialize_process_fnc=_plumb_job,
    job_entrypoint_fnc=_entrypoint,
    num_idle_processes=1  # Always ready
)
```

### Tools Integration

The voice agent has full access to the system:

```python
@function_tool
async def check_calendar(
    day: str = "today"  # today, tomorrow, Monday, 2026-02-25, range:2026-02-25:2026-02-27
) -> str:
    """Check Joel's calendar for a specific day or range."""
    # Executes gog CLI with proper auth
    
@function_tool  
async def add_task(
    content: str,
    due: Optional[str] = None,  # today, tomorrow, Monday, 2026-02-25
    labels: Optional[List[str]] = None,
    priority: Optional[int] = None  # 1-4, 4 highest
) -> str:
    """Add a task to Joel's Todoist."""
    # Uses todoist-cli with full TaskPort
```

Plus: email triage, vault search, system health, Inngest event dispatch, and dynamic voice switching.

### Security Model

Simple but effective:

```python
ALLOWED_CALLERS = {"[REDACTED]"}  # Allowlist

caller = _extract_caller(ctx.room.name)  # sip_PHONENUMBER format
if caller not in ALLOWED_CALLERS:
    # Polite rejection via brief voicemail
    return
```

Future phases will add caller tiers — read-only access for some numbers, full control for others.

## What Works

### Inbound Calls

Call the system number. Panda (the AI's voice persona) answers immediately. Full conversation with function calling. Calendar queries, task creation, system status — all via voice.

### Outbound Calls

```bash
lk sip participant create \
  --trunk [TRUNK_ID] \
  --call +1XXXXXXXXXX \
  --room voice-outbound-joel
```

The agent auto-joins any room matching `voice-outbound-*`. Voice callbacks will integrate with the gateway — completion events with `callback: "voice"` trigger outbound calls.

### Voice Quality

- **Latency**: 1-2 seconds turn-to-turn
- **Audio**: Crystal clear after enabling jitter buffer
- **Interruption**: VAD handles talk-over gracefully
- **Cost**: ~$0.04/minute all-in

## Configuration Highlights

### SIP on Edge Node

```yaml
services:
  livekit-sip:
    image: livekit/sip:v0.2.0
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"  
      - "10000-20000:10000-20000/udp"
    environment:
      LIVEKIT_URL: ws://[TAILSCALE_IP]:7880
      LIVEKIT_API_KEY: [KEY]
      USE_JITTER_BUFFER: true  # Critical for quality
```

### Voice Agent Identity

System prompt built from soul files:

```python
soul = (Path.home() / ".agents" / "SOUL.md").read_text()
identity = (Path.home() / ".agents" / "IDENTITY.md").read_text()
user = (Path.home() / ".agents" / "USER.md").read_text()

system_prompt = f"""{soul}

## Identity
{identity}

## User Context  
{user}

[Voice-specific rules...]

## Vibe
You have an Australian accent. Swear naturally when it fits.
"""
```

### Persistence

```bash
# ~/Projects/joelclaw-voice-agent/run.sh
#!/bin/bash
source .venv/bin/activate
exec python main.py start
```

Runs via `screen` session. Survives SSH disconnects. Logs to `/tmp/joelclaw/voice-agent.log`.

## Troubleshooting Notes

Common issues encountered during deployment:

**WebSocket failures** — Agent defaulted to `localhost:7880` which routes nowhere in containerized environment. Solution: explicit Tailscale IPs.

**Dev mode instability** — File watcher saw its own logs change, restarted every 12 seconds. Solution: use `start` mode for production.

**SIP trunk format conflicts** — Multiple formats for same number causes ambiguous routing. Solution: single E.164 format throughout.

**Voice library access** — ElevenLabs voices must be "added to my voices" before API access. Not documented, learned through trial.

**Background noise** — Default VAD threshold (0.5) triggered on ambient sound. Raised to 0.85 for phone environment.

## What's Next

**Phase 2**: Scheduled calls — morning briefings, weekly retrospectives  
**Phase 3**: Telegram voice messages — async voice notes to/from the bot  
**Phase 4**: Proactive outreach — context-aware check-ins  

The foundation is solid. Voice is just another interface to the system — same tools, same data, same capabilities. Just more human.

---

_Part of the joelclaw deployment series. Source: [github.com/joelhooks/joelclaw](https://github.com/joelhooks/joelclaw)_