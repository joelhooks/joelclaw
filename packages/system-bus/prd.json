{
  "title": "ADR-0015: TDD loop architecture with separated roles",
  "description": "Restructure the agent loop from implement→test→judge to test→implement→review→judge. Five roles: planner (existing), test writer (new), implementor (existing, reordered), reviewer (rewritten as evaluator), judge (rewritten to consume reviewer notes + LLM evaluation). The llmEvaluate and getStoryDiff helpers already exist in utils.ts from the prior loop.",
  "stories": [
    {
      "id": "LOOP-1",
      "title": "Create test writer Inngest function (agent/loop.test)",
      "description": "Create a new file `src/inngest/functions/agent-loop/test-writer.ts` with an Inngest function listening on `agent/loop.test`. It receives: loopId, project, storyId, story (with acceptance_criteria), tool, attempt, maxRetries, maxIterations, storyStartedAt, retryLadder. The function: (1) checks cancellation, (2) builds a prompt that instructs the agent to write acceptance tests from the story's criteria — tests should verify observable behavior and intent, NOT internal structure, (3) spawns the tool (claude/codex) with the prompt in the project directory, (4) commits any new test files with message 'test: [{loopId}] [{storyId}] acceptance tests', (5) emits `agent/loop.implement` with all loop state plus the test file paths. Use the same spawnReviewer pattern from review.ts for spawning. Register the function in index.ts exports.",
      "acceptance_criteria": [
        "test-writer.ts exists and exports agentLoopTestWriter",
        "Listens on agent/loop.test event",
        "Spawns tool with prompt focused on acceptance criteria (not implementation details)",
        "Commits test files before emitting implement",
        "Emits agent/loop.implement after committing tests",
        "Registered in index.ts",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 1,
      "status": "passed",
      "passes": true
    },
    {
      "id": "LOOP-2",
      "title": "Restructure event chain: plan→test→implement→review→judge",
      "description": "Update the event chain so the flow is: plan emits `agent/loop.test` (not implement), test-writer emits `agent/loop.implement`, implement emits `agent/loop.review` (unchanged), review emits `agent/loop.judge` (unchanged). Changes needed: (1) In plan.ts, change the emitted event from `agent/loop.implement` to `agent/loop.test`, passing the same data. (2) In implement.ts, verify it still emits `agent/loop.review` after committing. (3) Ensure the retry path in judge.ts emits `agent/loop.implement` (not test) — on retry, tests already exist, only the implementation needs to be redone.",
      "acceptance_criteria": [
        "plan.ts emits agent/loop.test instead of agent/loop.implement",
        "test-writer.ts emits agent/loop.implement after writing tests",
        "implement.ts still emits agent/loop.review",
        "review.ts still emits agent/loop.judge",
        "Judge retry emits agent/loop.implement (skips test writing on retry)",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 2,
      "status": "pending",
      "passes": true
    },
    {
      "id": "LOOP-3",
      "title": "Rewrite reviewer as 4-question evaluator",
      "description": "Rewrite review.ts so the reviewer NO LONGER writes tests. Instead, it evaluates the implementation by answering four questions: (1) Are there new test files? (check git diff for *.test.* files), (2) Do tests test real implementations, not stubs? (LLM reads test code), (3) Are tests truthful, not gaming? (LLM reads implementation + tests), (4) Does test + implementation accomplish the story intent from the ADR? The reviewer: (a) runs typecheck + lint + tests (keep existing runChecks), (b) reads the diff via getStoryDiff, (c) reads test files from disk, (d) calls claude with a structured evaluation prompt for questions 2-4, (e) outputs structured JSON notes: { questions: [{id, answer: boolean, evidence: string}], testResults: {...} }, (f) emits agent/loop.judge with the notes. Remove all test-writing code (buildTestPrompt, spawnReviewer for test writing, deleteExistingTestFiles).",
      "acceptance_criteria": [
        "review.ts no longer writes test files",
        "review.ts runs checks (typecheck, lint, tests) — keeps runChecks",
        "review.ts evaluates 4 questions with structured output",
        "Outputs JSON notes with question answers and evidence",
        "Emits agent/loop.judge with reviewer notes attached",
        "buildTestPrompt removed or replaced with evaluation prompt",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 3,
      "status": "pending",
      "passes": true
    },
    {
      "id": "LOOP-4",
      "title": "Rewrite judge to consume reviewer notes + LLM verdict",
      "description": "Rewrite judge.ts to: (1) receive reviewer notes (4-question evaluation) from the review event data, (2) check mechanical gates first (typecheckOk, lintOk, testsFailed === 0), (3) if mechanical gates pass, call llmEvaluate (already in utils.ts) with the story acceptance criteria, diff (from getStoryDiff), test file content, test results summary, and project conventions, (4) combine the LLM verdict with reviewer notes to make a final decision, (5) PASS only if: mechanical gates pass AND reviewer notes show no red flags AND LLM verdict is pass, (6) on FAIL, include specific reasoning from reviewer notes + LLM reasoning in the feedback sent to implementor for retry. Keep the existing retry ladder and skip-after-max-retries logic.",
      "acceptance_criteria": [
        "judge.ts receives and uses reviewer notes from event data",
        "Checks mechanical gates first (typecheck, lint, tests)",
        "Calls llmEvaluate when mechanical gates pass",
        "Combines reviewer notes + LLM verdict for final decision",
        "FAIL if reviewer flags issues even when tests pass",
        "Feedback to implementor includes specific reasoning",
        "Retry ladder and skip logic preserved",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 4,
      "status": "pending"
    },
    {
      "id": "LOOP-5",
      "title": "Integration: end-to-end event chain with all roles",
      "description": "Verify the full chain works by checking: (1) all five functions are registered in index.ts (plan, test-writer, implement, review, judge), (2) the event types flow correctly (plan→test→implement→review→judge), (3) no circular imports between the files, (4) the existing llmEvaluate.test.ts and getStoryDiff.test.ts still pass, (5) no leftover test-writing code in review.ts. This is a wiring verification story, not a new feature. Fix any import errors or type mismatches introduced by LOOP-1 through LOOP-4.",
      "acceptance_criteria": [
        "All 5 functions exported from index.ts",
        "No circular imports between agent-loop files",
        "Existing tests pass: bun test src/inngest/functions/agent-loop/",
        "No test-writing code remains in review.ts",
        "TypeScript compiles cleanly: bunx tsc --noEmit",
        "Event chain: plan emits test, test emits implement, implement emits review, review emits judge"
      ],
      "priority": 5,
      "status": "pending"
    }
  ]
}
