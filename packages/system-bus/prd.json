{
  "title": "ADR-0021 Phase 1 Loop B: Create observe.ts Inngest function",
  "stories": [
    {
      "id": "OBS-1",
      "title": "Create observe.ts with function scaffold and event triggers",
      "description": "Create src/inngest/functions/observe.ts exporting observeSessionFunction. Configure triggers for 'memory/session.compaction.pending' and 'memory/session.ended' events. Add basic function structure with inngest.createFunction including id 'memory/observe-session' and name 'Observe Session'. Import existing OBSERVER_SYSTEM_PROMPT and OBSERVER_USER_PROMPT from ./observe-prompt.ts. Set up step.run placeholders for the 6 required steps: validate-input, call-observer-llm, parse-observations, store-to-qdrant, update-redis-state, emit-accumulated.",
      "acceptance_criteria": [
        "File src/inngest/functions/observe.ts exists",
        "Exports observeSessionFunction using inngest.createFunction",
        "Configured with both event triggers: 'memory/session.compaction.pending' and 'memory/session.ended'",
        "Imports OBSERVER_SYSTEM_PROMPT and OBSERVER_USER_PROMPT from ./observe-prompt.ts",
        "Contains step.run placeholders for all 6 steps with correct names",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 1,
      "passes": false,
      "skipped": true
    },
    {
      "id": "OBS-2",
      "title": "Implement validate-input and call-observer-llm steps",
      "description": "In observe.ts, implement the validate-input step to verify event.data contains required session data. Implement call-observer-llm step using pi CLI as subprocess (Bun.$) with OBSERVER_SYSTEM_PROMPT and OBSERVER_USER_PROMPT. Capture stdout/stderr and handle errors. The pi subprocess should receive the prompts and session context.",
      "acceptance_criteria": [
        "validate-input step checks for required event.data fields and throws if missing",
        "call-observer-llm step spawns pi subprocess using Bun.$",
        "Prompts from observe-prompt.ts are passed to pi CLI correctly",
        "Step captures and returns LLM output as string",
        "Error handling for subprocess failures is present",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "OBS-3",
      "title": "Implement parse-observations step using observe-parser",
      "description": "In observe.ts, implement parse-observations step using parseObserverOutput from ./observe-parser.ts. Pass the LLM output from call-observer-llm step to parser. Handle parsing errors gracefully and return structured observations including segments, concepts, and facts.",
      "acceptance_criteria": [
        "parse-observations step imports and calls parseObserverOutput from ./observe-parser.ts",
        "Step receives output from previous call-observer-llm step",
        "Returns structured observation data (segments, concepts, facts)",
        "Includes error handling for malformed LLM output",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 3,
      "passes": false,
      "skipped": true
    },
    {
      "id": "OBS-4",
      "title": "Implement store-to-qdrant step",
      "description": "In observe.ts, implement store-to-qdrant step using @qdrant/js-client-rest. Connect to localhost:6333, use collection 'memory_observations'. Store each observation with 768-dimension zero vector placeholder (temporary until embeddings added later). Include metadata: session_id, timestamp, observation type. Handle connection and storage errors.",
      "acceptance_criteria": [
        "store-to-qdrant step imports QdrantClient from @qdrant/js-client-rest",
        "Connects to localhost:6333",
        "Uses collection name 'memory_observations'",
        "Stores observations with 768-dim zero vector placeholder",
        "Includes required metadata fields in payloads",
        "Error handling for Qdrant connection/storage failures",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 4,
      "passes": true
    },
    {
      "id": "OBS-5",
      "title": "Implement update-redis-state and emit-accumulated steps",
      "description": "In observe.ts, implement update-redis-state step to update Redis key pattern 'memory:latest:{date}' with observation summary. Implement emit-accumulated step to emit 'memory/observations.accumulated' event with session_id and observation count. Use Redis client for state update and inngest event emission.",
      "acceptance_criteria": [
        "update-redis-state step updates Redis with key pattern 'memory:latest:{date}'",
        "Redis update includes observation summary/metadata",
        "emit-accumulated step emits 'memory/observations.accumulated' event",
        "Emitted event includes session_id and observation count in data",
        "Both steps include error handling",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "OBS-6",
      "title": "Register observeSessionFunction in index.ts and serve.ts",
      "description": "Import observeSessionFunction from ./observe.ts into both src/inngest/functions/index.ts and src/serve.ts. Add to the functions array in both files. Ensure no duplicate event trigger registrations. Verify the function is properly exported and available for Inngest server.",
      "acceptance_criteria": [
        "src/inngest/functions/index.ts imports and exports observeSessionFunction",
        "src/serve.ts imports and includes observeSessionFunction in serve() call",
        "No duplicate event trigger warnings or errors",
        "Function appears in both registration locations",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 6,
      "passes": false
    }
  ]
}
