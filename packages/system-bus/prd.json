{
  "title": "ADR-0021 Phase 1 Loop B: Implement observe Inngest function",
  "stories": [
    {
      "id": "OBS-1",
      "title": "Install @qdrant/js-client-rest dependency",
      "description": "Add @qdrant/js-client-rest to package.json dependencies using bun add @qdrant/js-client-rest",
      "acceptance_criteria": [
        "package.json contains @qdrant/js-client-rest in dependencies",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 1,
      "passes": false
    },
    {
      "id": "OBS-2",
      "title": "Create observe.ts Inngest function with 6 steps",
      "description": "Create src/inngest/functions/observe.ts exporting observeSessionFunction. Function should be triggered by 'memory/session.compaction.pending' and 'memory/session.ended' events. Implement 6 steps: (1) validate-input: extract sessionId, messages, trigger from event data, return early if messages empty; (2) call-observer-llm: spawn pi CLI subprocess with --no-session --model 'anthropic/claude-haiku-4-5' using OBSERVER_SYSTEM_PROMPT and OBSERVER_USER_PROMPT imported from ./observe-prompt; (3) parse-observations: call parseObserverOutput(stdout) from ./observe-parser; (4) store-to-qdrant: upsert to 'memory_observations' collection at localhost:6333 with UUID id, 768-dim zero vector, payload containing sessionId, trigger, observations, segments as JSON, currentTask, suggestedResponse, capturedAt timestamp, date; (5) update-redis-state: SET 'memory:latest:{date}' key with JSON metadata; (6) emit-accumulated: send memory/observations.accumulated event",
      "acceptance_criteria": [
        "src/inngest/functions/observe.ts exists and exports observeSessionFunction",
        "Function has both 'memory/session.compaction.pending' and 'memory/session.ended' triggers",
        "Imports OBSERVER_SYSTEM_PROMPT and OBSERVER_USER_PROMPT from ./observe-prompt",
        "Imports parseObserverOutput from ./observe-parser",
        "Contains 6 step.run calls: validate-input, call-observer-llm, parse-observations, store-to-qdrant, update-redis-state, emit-accumulated",
        "call-observer-llm step spawns pi subprocess with correct flags",
        "store-to-qdrant step connects to Qdrant at localhost:6333 and upserts to memory_observations collection",
        "update-redis-state step writes to Redis key matching pattern memory:latest:{date}",
        "emit-accumulated step sends memory/observations.accumulated event",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 2,
      "passes": false
    },
    {
      "id": "OBS-3",
      "title": "Register observe function in index.ts and serve.ts",
      "description": "Import observeSessionFunction in src/inngest/index.ts and src/serve.ts. Add to the functions array in both files. Ensure no duplicate trigger registrations.",
      "acceptance_criteria": [
        "src/inngest/index.ts imports observeSessionFunction from ./functions/observe",
        "src/inngest/index.ts includes observeSessionFunction in exported functions array",
        "src/serve.ts imports observeSessionFunction from ./inngest/functions/observe",
        "src/serve.ts includes observeSessionFunction in serve call functions array",
        "No duplicate trigger IDs exist across registered functions",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 3,
      "passes": false
    }
  ]
}
