{
  "title": "ADR-0028 Items 1-3: step.sendEvent, NonRetriableError, cancelOn",
  "stories": [
    {
      "id": "SEND-1",
      "title": "Replace inngest.send() with step.sendEvent() in observe.ts and system-logger.ts",
      "description": "In src/inngest/functions/observe.ts and src/inngest/functions/system-logger.ts, find all patterns where inngest.send() is called inside a step.run() wrapper and replace them with step.sendEvent(). The step ID string should remain the same. Import step from the function handler signature (it is already present). Remove any now-unused inngest.send() imports if inngest client is no longer referenced in that file. For batch sends, step.sendEvent() accepts an array of events.",
      "acceptance_criteria": [
        "grep -r \"inngest.send\" src/inngest/functions/observe.ts returns 0 matches",
        "grep -r \"inngest.send\" src/inngest/functions/system-logger.ts returns 0 matches",
        "step.sendEvent() calls exist in observe.ts and system-logger.ts where inngest.send() previously existed",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 1,
      "passes": false,
      "skipped": true
    },
    {
      "id": "SEND-2",
      "title": "Replace inngest.send() with step.sendEvent() in video-download.ts and transcript-process.ts",
      "description": "In src/inngest/functions/video-download.ts and src/inngest/functions/transcript-process.ts, find all patterns where inngest.send() is called inside a step.run() wrapper and replace them with step.sendEvent(). Both files may have batch sends (arrays of events) — pass the array directly to step.sendEvent(). Keep step IDs unchanged. Remove any now-unused inngest client imports if applicable.",
      "acceptance_criteria": [
        "grep -r \"inngest.send\" src/inngest/functions/video-download.ts returns 0 matches",
        "grep -r \"inngest.send\" src/inngest/functions/transcript-process.ts returns 0 matches",
        "step.sendEvent() calls exist in both files where inngest.send() previously existed",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 2,
      "passes": false,
      "skipped": true
    },
    {
      "id": "SEND-3",
      "title": "Replace inngest.send() with step.sendEvent() in all remaining agent-loop functions",
      "description": "Find all remaining inngest.send() calls inside step.run() wrappers across all files in src/inngest/functions/ not already covered by SEND-1 and SEND-2 (e.g. plan.ts, reflect.ts, promote.ts, content-sync.ts, vault-sync.ts, discovery-capture.ts, summarize.ts, and any agent-loop subfunctions). Replace each with step.sendEvent() using the same step ID. Run: grep -r \"inngest.send\" src/inngest/functions/ --include=\"*.ts\" | grep -v test to find all remaining sites. The final result must be zero matches.",
      "acceptance_criteria": [
        "grep -r \"inngest.send\" src/inngest/functions/ --include=\"*.ts\" | grep -v test returns 0 matches",
        "step.sendEvent() is used for all event emission inside Inngest function handlers",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 3,
      "passes": false,
      "skipped": true
    },
    {
      "id": "ERR-1",
      "title": "Add NonRetriableError for validation failures in observe.ts, transcript-process.ts, plan.ts, video-download.ts",
      "description": "Import NonRetriableError from 'inngest' in the four files: src/inngest/functions/observe.ts, src/inngest/functions/transcript-process.ts, src/inngest/functions/plan.ts, src/inngest/functions/video-download.ts. Replace plain Error throws with NonRetriableError for these specific conditions: observe.ts — 'Missing required session field' (input validation, payload is malformed); transcript-process.ts — 'requires either audioPath or text' (schema violation); plan.ts — 'Worktree missing' (infrastructure state won't fix on retry) and 'Generated PRD has no stories' (LLM output issue, same prompt = same result); video-download.ts — 'No .info.json found' (download produced nothing usable). Leave all other Error throws as plain Error.",
      "acceptance_criteria": [
        "grep -r \"NonRetriableError\" src/inngest/functions/ --include=\"*.ts\" returns matches in observe.ts, transcript-process.ts, plan.ts, and video-download.ts",
        "NonRetriableError is imported from 'inngest' in each of the four files",
        "The specific error conditions listed (missing session field, audioPath/text schema, worktree missing, no stories, no info.json) throw NonRetriableError not plain Error",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "CANCEL-1",
      "title": "Add cancelOn to all 7 agent-loop functions",
      "description": "Add a cancelOn configuration to the Inngest function definition for each of the 7 agent-loop functions: plan, test-writer, implement, review, judge, complete, retro. These are likely in src/inngest/functions/ (possibly in an agent-loop/ subdirectory). Each function definition should add: cancelOn: [{ event: 'agent/loop.cancelled', if: 'event.data.loopId == async.data.loopId' }]. The 'async' refers to the triggering event's data (the event that started the function run). Ensure the loopId field exists in the event data type for agent/loop.cancelled in the Events type definition (src/inngest/client.ts or similar). Do NOT remove existing isCancelled() polling — leave it as a belt-and-suspenders check. Only add cancelOn to the function configuration object.",
      "acceptance_criteria": [
        "grep -r \"cancelOn\" src/inngest/functions/ --include=\"*.ts\" returns matches in all 7 loop function files (plan, test-writer, implement, review, judge, complete, retro)",
        "Each cancelOn references event 'agent/loop.cancelled' with if condition matching loopId",
        "The agent/loop.cancelled event has loopId in its data type in the Events schema",
        "Existing isCancelled() calls are not removed",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "VERIFY-1",
      "title": "Run full test suite and verify ADR-0028 items 1-3 verification checklist",
      "description": "Run the complete verification checklist from ADR-0028 for items 1-3: (1) grep -r 'inngest.send' src/inngest/functions/ --include='*.ts' | grep -v test returns 0 matches; (2) grep -r 'NonRetriableError' src/inngest/functions/ --include='*.ts' returns matches in observe, transcript-process, plan, video-download; (3) grep -r 'cancelOn' src/inngest/functions/agent-loop/ --include='*.ts' returns matches in all 7 loop functions. If the agent-loop functions are not in a subdirectory named agent-loop/, adjust the grep path accordingly. Run bun test and fix any test failures caused by the changes in stories SEND-1 through CANCEL-1. Do not modify tests to work around behavior changes — fix the implementation if tests reveal a real bug.",
      "acceptance_criteria": [
        "grep -r \"inngest.send\" src/inngest/functions/ --include=\"*.ts\" | grep -v test returns 0 matches",
        "grep -r \"NonRetriableError\" src/inngest/functions/ --include=\"*.ts\" returns at least 4 files with matches",
        "cancelOn is present in all 7 agent-loop function definitions",
        "bun test passes with no failures",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 6,
      "passes": false
    }
  ]
}
