{
  "title": "ADR-0021 Nuum: Segment-aware distillation for observer prompt and parser",
  "stories": [
    {
      "id": "NUUM-1",
      "title": "Rewrite OBSERVER_SYSTEM_PROMPT for segment-aware distillation",
      "description": "Rewrite the OBSERVER_SYSTEM_PROMPT in src/inngest/functions/observe-prompt.ts to instruct the LLM to perform segment-aware distillation instead of flat observation extraction. The new prompt should instruct the model to: (1) identify coherent conversation segments â€” groups of related messages about one topic (debugging a bug, implementing a feature, making a decision), using topic shifts, natural breakpoints, and temporal clustering as boundaries. (2) For each segment, produce TWO distillates: an 'operational context' (1-3 sentences explaining what happened â€” the narrative) and 'retained facts' (bullet list of specific file paths, values, decisions with rationale, gotchas, error messages and fixes, user preferences discovered). The output format wraps each segment in <segment> tags inside the existing <observations> tag, with <narrative> and <facts> sub-tags. Keep <current-task> and <suggested-response> tags unchanged. Preserve the priority markers (ðŸ”´/ðŸŸ¡/ðŸŸ¢) on individual facts within segments. Credit: Segment-aware distillation pattern from Nuum (Simen Svale / Sanity).",
      "acceptance_criteria": [
        "observe-prompt.ts OBSERVER_SYSTEM_PROMPT instructs segment identification before extraction",
        "Prompt specifies operational context (1-3 sentence narrative) per segment via <narrative> tag",
        "Prompt specifies retained facts (bullet list with specifics) per segment via <facts> tag",
        "Prompt preserves ðŸ”´/ðŸŸ¡/ðŸŸ¢ priority markers on individual facts",
        "Output format uses <segment> tags within <observations>",
        "<current-task> and <suggested-response> tags remain unchanged",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "NUUM-2",
      "title": "Add DistilledSegment interface and parseSegments function",
      "description": "In src/inngest/functions/observe-parser.ts, add a new exported interface DistilledSegment with fields: narrative (string) and facts (string[]). Add a new exported function parseSegments(observations: string): DistilledSegment[] that extracts <segment> blocks from the observations text, parsing <narrative> content as the narrative string and <facts> bullet items as the facts array. Each bullet should be trimmed. If no <segment> tags are found, return an empty array.",
      "acceptance_criteria": [
        "observe-parser.ts exports DistilledSegment interface with narrative (string) and facts (string[])",
        "observe-parser.ts exports parseSegments function with signature (observations: string) => DistilledSegment[]",
        "parseSegments correctly extracts narrative and facts from <segment> blocks",
        "parseSegments returns empty array when no <segment> tags are present",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "NUUM-3",
      "title": "Update ObserverOutput and parseObserverOutput for segments",
      "description": "In src/inngest/functions/observe-parser.ts, add a segments: DistilledSegment[] field to the ObserverOutput interface. Update parseObserverOutput to call parseSegments on the extracted observations text and populate the segments field. When <segment> tags are present, segments is populated with parsed data. When no <segment> tags exist (flat format), segments is an empty array â€” preserving full backward compatibility. The existing observations string field continues to contain the raw text between <observations> tags.",
      "acceptance_criteria": [
        "ObserverOutput interface includes segments: DistilledSegment[] field",
        "parseObserverOutput returns populated segments when <segment> tags are present in observations",
        "parseObserverOutput returns empty segments array for flat-format input (backward compat)",
        "Existing observations, currentTask, suggestedResponse fields still work correctly",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 3,
      "passes": false,
      "skipped": true
    },
    {
      "id": "NUUM-4",
      "title": "Update optimizeForContext for segment-aware format",
      "description": "In src/inngest/functions/observe-parser.ts, refactor optimizeForContext to handle both formats. When the input contains <segment> tags (detected via parseSegments returning non-empty): keep all narratives and only ðŸ”´-marked facts, dropping ðŸŸ¡ and ðŸŸ¢ facts. When no segments are found (flat format): keep existing behavior (lines with ðŸ”´ or 'Date:' prefix). The function signature remains unchanged â€” it takes a string and returns a string.",
      "acceptance_criteria": [
        "optimizeForContext handles segment-aware input: keeps all narratives + only ðŸ”´ facts",
        "optimizeForContext drops ðŸŸ¡ and ðŸŸ¢ facts from segment-aware input",
        "optimizeForContext still works with flat-format input unchanged (backward compat)",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 4,
      "passes": false,
      "skipped": true
    },
    {
      "id": "NUUM-5",
      "title": "Add formatSegmentsForLog export",
      "description": "In src/inngest/functions/observe-parser.ts, add a new exported function formatSegmentsForLog(segments: DistilledSegment[]): string that renders segments as markdown suitable for a daily log. Each segment becomes a subsection with the narrative rendered in italics (wrapped in *...*) followed by fact bullets (each prefixed with '- '). Segments are separated by blank lines. Returns empty string for empty array input.",
      "acceptance_criteria": [
        "observe-parser.ts exports formatSegmentsForLog function",
        "formatSegmentsForLog renders narrative in italics (*narrative*)",
        "formatSegmentsForLog renders facts as markdown bullet list (- fact)",
        "formatSegmentsForLog returns empty string for empty segments array",
        "Segments are separated by blank lines in output",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "NUUM-6",
      "title": "Add tests for segment-aware parsing",
      "description": "In src/inngest/functions/observe-parser.test.ts, add test cases covering the new segment-aware functionality: (1) parseSegments with valid <segment> blocks containing <narrative> and <facts> returns correct DistilledSegment[], (2) parseSegments with no segment tags returns [], (3) parseObserverOutput with segment-format input populates segments array, (4) parseObserverOutput with flat-format input returns empty segments array (backward compat), (5) optimizeForContext with segment input keeps narratives + ðŸ”´ facts only, (6) optimizeForContext with flat input still works, (7) formatSegmentsForLog renders segments as markdown with italic narratives and bullet facts, (8) formatSegmentsForLog returns empty string for empty array. All existing tests must continue to pass.",
      "acceptance_criteria": [
        "Tests cover parseSegments with valid segment XML including narrative and facts",
        "Tests cover parseSegments with empty/no-segment input returning []",
        "Tests cover parseObserverOutput segment population with segment-format input",
        "Tests cover parseObserverOutput backward compat with flat-format input",
        "Tests cover optimizeForContext with segment-aware input (narratives + ðŸ”´ only)",
        "Tests cover optimizeForContext backward compat with flat-format input",
        "Tests cover formatSegmentsForLog output format",
        "All existing tests still pass",
        "bun test passes",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 6,
      "passes": false
    }
  ]
}
