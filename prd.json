{
  "title": "Gateway Phase 1+2: Pi extension + Inngest heartbeat + pushGatewayEvent wiring",
  "description": "Implement ADR-0018 Phases 1 and 2. The gateway bridges Inngest events into pi sessions via Redis. Phase 1: a pi extension at ~/.pi/agent/extensions/gateway/index.ts that subscribes to Redis pub/sub, drains a Redis list of SystemEvents, and injects them into the active pi session via sendUserMessage(). Phase 2: an Inngest pushGatewayEvent() helper in the monorepo that LPUSH+PUBLISH events, a heartbeat cron function, and wiring into agent-loop-complete and video pipelines so they push notifications. The Redis event schema: key joelclaw:events:{sessionKey} (list), notify channel joelclaw:notify:{sessionKey}. SystemEvent = {id, type, source, payload, ts}. IMPORTANT: the pi extension lives at ~/.pi/agent/extensions/gateway/ (NOT in the monorepo). For monorepo stories, work in packages/system-bus/. Read ADR-0018 at ~/Vault/docs/decisions/0018-pi-native-gateway-redis-event-bridge.md for full specification.",
  "stories": [
    {
      "id": "PUSH-1",
      "title": "Add pushGatewayEvent helper to utils.ts",
      "description": "Add a pushGatewayEvent() function to packages/system-bus/src/inngest/functions/agent-loop/utils.ts. It takes {type, source, payload} and creates a full SystemEvent with id (crypto.randomUUID()), ts (Date.now()), then LPUSH to joelclaw:events:main and PUBLISH to joelclaw:notify:main with {eventId, type}. Use the existing getRedis() singleton. Export it. Also add the SystemEvent type definition.",
      "acceptance_criteria": [
        "pushGatewayEvent function exists in utils.ts and is exported",
        "SystemEvent type is defined: {id: string, type: string, source: string, payload: Record<string, unknown>, ts: number}",
        "Function LPUSH to key joelclaw:events:main with JSON.stringify(event)",
        "Function PUBLISH to channel joelclaw:notify:main with JSON.stringify({eventId, type})",
        "Uses existing getRedis() from same file, not a new Redis client",
        "TypeScript compiles: cd packages/system-bus && bunx tsc --noEmit"
      ],
      "priority": 1
    },
    {
      "id": "WIRE-1",
      "title": "Wire pushGatewayEvent into agent-loop-complete",
      "description": "In packages/system-bus/src/inngest/functions/agent-loop/complete.ts, add a new step.run('emit-gateway-event', ...) AFTER the existing merge/sync steps. It should call pushGatewayEvent with type 'loop.complete' or 'loop.failed' based on the outcome, source 'inngest', and payload containing loopId, storiesCompleted count, storiesFailed count, and the loop title from the PRD. Import pushGatewayEvent from ./utils. This step should be wrapped in try/catch so gateway notification failure does NOT fail the complete function.",
      "acceptance_criteria": [
        "complete.ts imports pushGatewayEvent from ./utils",
        "A step.run('emit-gateway-event', ...) exists in complete.ts",
        "The step calls pushGatewayEvent with type 'loop.complete' or 'loop.failed'",
        "Payload includes loopId and story counts",
        "The step is wrapped in try/catch so failures are swallowed (gateway notification is best-effort)",
        "The step is AFTER the merge/sync steps, not before",
        "TypeScript compiles: cd packages/system-bus && bunx tsc --noEmit"
      ],
      "priority": 2
    },
    {
      "id": "WIRE-2",
      "title": "Wire pushGatewayEvent into video-download and transcript-process",
      "description": "Add pushGatewayEvent calls to video-download.ts (after the emit-events step) and transcript-process.ts (after the emit-events step). For video-download: type 'media.downloaded', payload {slug, title, nasPath}. For transcript-process: type 'media.transcribed', payload {title, vaultPath}. Both should be best-effort (try/catch). Import pushGatewayEvent from the agent-loop/utils path (it lives there but is usable by any function).",
      "acceptance_criteria": [
        "video-download.ts has a step.run calling pushGatewayEvent with type 'media.downloaded'",
        "transcript-process.ts has a step.run calling pushGatewayEvent with type 'media.transcribed'",
        "Both steps are wrapped in try/catch",
        "Both import pushGatewayEvent from the correct path",
        "TypeScript compiles: cd packages/system-bus && bunx tsc --noEmit"
      ],
      "priority": 3
    },
    {
      "id": "CRON-1",
      "title": "Add heartbeat cron and manual wake Inngest functions",
      "description": "Create packages/system-bus/src/inngest/functions/heartbeat.ts with two functions: (1) heartbeatCron triggered by cron 'TZ=America/Los_Angeles */30 * * * *' with id 'system-heartbeat', which calls pushGatewayEvent({type: 'cron.heartbeat', source: 'inngest', payload: {}}). (2) heartbeatWake triggered by event 'system/heartbeat.wake' which does the same thing (for manual triggers). Add the 'system/heartbeat.wake' event type to client.ts events. Export both functions and register them in serve.ts (add to the functions array AND add to the console.log line that lists function names). Follow the pattern from existing functions like video-download.ts.",
      "acceptance_criteria": [
        "heartbeat.ts exists at packages/system-bus/src/inngest/functions/heartbeat.ts",
        "heartbeatCron uses cron trigger with TZ=America/Los_Angeles */30 * * * *",
        "heartbeatWake uses event trigger system/heartbeat.wake",
        "Both call pushGatewayEvent with type cron.heartbeat",
        "system/heartbeat.wake event type is added to client.ts",
        "Both functions are imported and registered in serve.ts functions array",
        "TypeScript compiles: cd packages/system-bus && bunx tsc --noEmit"
      ],
      "priority": 4
    },
    {
      "id": "CLI-1",
      "title": "Add joelclaw gateway subcommand tree to CLI",
      "description": "Add a gateway subcommand tree to packages/cli/src/cli.ts with three subcommands: (1) 'gateway status' - connects to Redis, checks LLEN joelclaw:events:main for queue depth, checks PUBSUB NUMSUB joelclaw:notify:main for subscriber count, returns HATEOAS JSON. (2) 'gateway events' - LRANGE joelclaw:events:main 0 -1, returns parsed events as JSON array. (3) 'gateway push' - takes a --type and --data flag, creates a SystemEvent, LPUSH + PUBLISH. Create packages/cli/src/commands/gateway.ts for the implementation. Use ioredis (already in package.json deps). Follow the respond() envelope pattern from other commands.",
      "acceptance_criteria": [
        "packages/cli/src/commands/gateway.ts exists",
        "gateway command is wired into cli.ts withSubcommands",
        "joelclaw gateway status returns JSON with queueDepth and subscriberCount",
        "joelclaw gateway events returns JSON array of pending events",
        "joelclaw gateway push --type test --data '{\"smoke\":true}' pushes an event",
        "All three use respond() envelope with ok, command, result, next_actions",
        "TypeScript compiles: cd packages/cli && bunx tsc --noEmit"
      ],
      "priority": 5
    }
  ],
  "checks": ["tsc"]
}
