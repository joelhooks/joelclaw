{
  "name": "Memory Phase 3+4: Promotion Wiring + Friction Analysis",
  "description": "Wire the memory proposal pipeline end-to-end (ADR-0021 Phases 3-4). Proposals accumulate in Redis but never reach Joel. Fix: Reflector creates Todoist tasks, completion triggers promotion to MEMORY.md. Then build friction analysis cron.",
  "adr": "ADR-0021 (Comprehensive Agent Memory System)",
  "stories": [
    {
      "id": "MEM-BRIDGE-1",
      "title": "Todoist memory-review bridge function",
      "description": "Create an Inngest function that listens to 'todoist/task.completed' events. When the completed task has 'memory-review' label, extract the proposal ID from the task description (format: 'Proposal: p-YYYYMMDD-NNN'), then emit 'memory/proposal.approved' with that proposalId. This bridges Todoist completion → memory promotion. Register in index.ts and serve.ts.",
      "priority": 1,
      "status": "pending",
      "tests": [
        "Function exists at packages/system-bus/src/inngest/functions/todoist-memory-bridge.ts",
        "Triggered by 'todoist/task.completed' event",
        "Skips tasks without 'memory-review' label (returns noop)",
        "Extracts proposal ID from task description via regex",
        "Emits 'memory/proposal.approved' with correct proposalId",
        "Registered in index.ts and serve.ts",
        "bunx tsc --noEmit passes"
      ],
      "files": [
        "packages/system-bus/src/inngest/functions/todoist-memory-bridge.ts",
        "packages/system-bus/src/inngest/functions/index.ts",
        "packages/system-bus/src/serve.ts"
      ],
      "passes": true
    },
    {
      "id": "MEM-BRIDGE-2",
      "title": "Reflector creates Todoist tasks for proposals",
      "description": "Update the 'stage-review' step in reflect.ts to create a Todoist task for each proposal using TodoistTaskAdapter from '../../tasks/adapters/todoist'. Task content: 'Memory: {change text truncated to 80 chars} → {section}'. Task description must include 'Proposal: {proposalId}' on its own line (the bridge function parses this). Labels: ['memory-review', 'agent']. Project: 'Agent Work'. Keep existing Redis storage — Todoist is the notification surface, Redis is source of truth.",
      "priority": 2,
      "status": "pending",
      "tests": [
        "reflect.ts stage-review step imports TodoistTaskAdapter",
        "Each proposal creates a Todoist task with memory-review label",
        "Task description contains 'Proposal: p-YYYYMMDD-NNN' on its own line",
        "Redis proposals still stored (not removed)",
        "bunx tsc --noEmit passes"
      ],
      "files": [
        "packages/system-bus/src/inngest/functions/reflect.ts"
      ],
      "passes": true
    },
    {
      "id": "MEM-BRIDGE-3",
      "title": "Expire stale proposals and clean up Todoist tasks",
      "description": "Update the daily cron handler in promote.ts to expire proposals older than 7 days. When expiring a Redis proposal, also complete the corresponding Todoist task (search by 'Proposal: {id}' in description using TodoistTaskAdapter.listTasks() then .completeTask()). Log expired proposals to the daily log. The cron already fires at '0 8 * * *' — add the expiry logic to the existing handler.",
      "priority": 3,
      "status": "pending",
      "tests": [
        "promote.ts cron handler imports TodoistTaskAdapter",
        "Proposals older than 7 days are expired from Redis",
        "Corresponding Todoist tasks are completed on expiry",
        "Expired proposals logged to daily log",
        "bunx tsc --noEmit passes"
      ],
      "files": [
        "packages/system-bus/src/inngest/functions/promote.ts"
      ],
      "passes": true
    },
    {
      "id": "MEM-FRICTION-1",
      "title": "Friction analysis Inngest function + prompt",
      "description": "Create friction.ts and friction-prompt.ts (ADR-0021 Phase 4). Daily cron at '0 7 * * *' (after reflector at 6 AM). Step 1: Query Qdrant memory_observations for all observations from past 7 days (use @qdrant/js-client-rest, scroll with filter date >= 7 days ago). Step 2: Group observations by semantic similarity (simple: group by date, future: clustering). Step 3: Call LLM (pi -p --no-session --no-extensions --model anthropic/claude-sonnet-4-6) with friction-prompt.ts system prompt + observations + current MEMORY.md + AGENTS.md. Step 4: Parse output for friction patterns. Step 5: For each pattern, create Todoist task via TodoistTaskAdapter with labels ['memory-review', 'agent', 'friction']. Concurrency limit 1. Gate: only runs if Qdrant has >= 100 points.",
      "priority": 4,
      "status": "pending",
      "tests": [
        "friction.ts exists with daily cron trigger",
        "friction-prompt.ts exists with system prompt for pattern detection",
        "Queries Qdrant for 7-day window of observations",
        "Gates on >= 100 Qdrant points (returns noop if insufficient data)",
        "Creates Todoist tasks with friction label for detected patterns",
        "Registered in index.ts and serve.ts",
        "bunx tsc --noEmit passes"
      ],
      "files": [
        "packages/system-bus/src/inngest/functions/friction.ts",
        "packages/system-bus/src/inngest/functions/friction-prompt.ts",
        "packages/system-bus/src/inngest/functions/index.ts",
        "packages/system-bus/src/serve.ts"
      ],
      "passes": true
    }
  ]
}