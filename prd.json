{
  "title": "Memory System Phase 3: Event-Driven Review Workflow",
  "stories": [
    {
      "id": "MEM-1",
      "title": "Remove REVIEW.md writes from reflect.ts",
      "description": "In packages/system-bus/src/inngest/functions/reflect.ts, remove all REVIEW.md file operations from the stage-review step. Specifically: remove the appendToFile(reviewPath, reviewBlock) call, remove the buildReviewBlock() function, remove reviewPath from return values, and remove any imports (appendToFile, existsSync, appendFileSync) that are no longer needed. Keep all Redis operations unchanged: redis.hset('memory:review:proposal:{id}', ...) and redis.rpush('memory:review:pending', ...). Keep the daily log append step and emit-complete event emission unchanged. Update reflect.test.ts to remove any assertions about REVIEW.md file writes.",
      "acceptance_criteria": [
        "No calls to appendToFile, existsSync, or appendFileSync remain in reflect.ts unless used by the daily log step",
        "buildReviewBlock() function is removed",
        "reviewPath is not referenced in reflect.ts",
        "bun test src/inngest/functions/reflect.test.ts passes with 0 failures",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "MEM-2",
      "title": "Add memory/proposal.approved and memory/proposal.rejected event types to client.ts",
      "description": "In packages/system-bus/src/inngest/client.ts, add two new event type definitions to the EventSchemas map: 'memory/proposal.approved' with data shape { proposalId: string; approvedBy: string } and 'memory/proposal.rejected' with data shape { proposalId: string; reason: string; rejectedBy: string }. Follow the existing event type pattern in that file.",
      "acceptance_criteria": [
        "'memory/proposal.approved' event type is defined in client.ts with proposalId and approvedBy fields",
        "'memory/proposal.rejected' event type is defined in client.ts with proposalId, reason, and rejectedBy fields",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "MEM-3",
      "title": "Rewrite promote.ts to be event-driven, remove REVIEW.md parsing",
      "description": "In packages/system-bus/src/inngest/functions/promote.ts, remove all REVIEW.md file reading/parsing: delete parseReviewMd(), getReviewPath(), removeProposalFromReview(), extractContentPath(), and the content/updated trigger. Add two new Inngest function triggers: one for 'memory/proposal.approved' that calls promoteToMemory(event.data.proposalId), and one for 'memory/proposal.rejected' that calls archiveProposal(event.data.proposalId, event.data.reason). Keep the cron '0 8 * * *' trigger for auto-expiry of proposals older than 7 days (iterate LRANGE memory:review:pending, call expireProposal() for those older than 7 days). Remove any removeProposalFromReview() calls from promoteToMemory(), archiveProposal(), and expireProposal(). Export promoteToMemory, archiveProposal, and expireProposal. Update promote.test.ts to test the new event-driven triggers instead of checkbox-driven ones.",
      "acceptance_criteria": [
        "No references to REVIEW.md, parseReviewMd, getReviewPath, removeProposalFromReview, or content/updated remain in promote.ts",
        "promote.ts registers handlers for memory/proposal.approved and memory/proposal.rejected events",
        "The daily 8 AM cron trigger is retained for auto-expiry",
        "promoteToMemory, archiveProposal, and expireProposal are exported from promote.ts",
        "bun test src/inngest/functions/promote.test.ts passes with 0 failures",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 3,
      "passes": true
    },
    {
      "id": "MEM-4",
      "title": "Add joelclaw review CLI command",
      "description": "In packages/system-bus/src/cli/commands/, create review.ts following the same pattern as existing commands (check send.ts, runs.ts, or loop.ts for structure). Implement subcommands: (1) joelclaw review â€” lists all pending proposals by reading LRANGE memory:review:pending 0 -1 then HGETALL memory:review:proposal:{id} for each, output as HATEOAS JSON with _actions for approve/reject; (2) joelclaw review approve <proposalId> â€” sends memory/proposal.approved event with approvedBy: 'joel'; (3) joelclaw review reject <proposalId> --reason <text> â€” sends memory/proposal.rejected event; (4) joelclaw review approve-all â€” sends one approved event per pending proposal; (5) joelclaw review expire â€” triggers expiry check for proposals older than 7 days. Register the command in packages/system-bus/src/cli/index.ts.",
      "acceptance_criteria": [
        "review.ts exists in packages/system-bus/src/cli/commands/",
        "review command is registered in packages/system-bus/src/cli/index.ts",
        "joelclaw review list subcommand reads from Redis and outputs HATEOAS JSON",
        "joelclaw review approve sends a memory/proposal.approved Inngest event",
        "joelclaw review reject --reason sends a memory/proposal.rejected Inngest event",
        "joelclaw review approve-all iterates all pending proposals",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 4,
      "passes": false,
      "skipped": true
    },
    {
      "id": "MEM-5",
      "title": "Add pending proposal count to session briefing",
      "description": "In ~/Code/joelhooks/pi-tools/session-lifecycle/index.ts, in the briefing injection hook (before_agent_start or equivalent first-turn hook), add a Redis query for LLEN memory:review:pending using ioredis connecting to localhost:6379. If count > 0, append a line to the briefing: 'ðŸ“‹ {N} pending memory proposals â€” run `joelclaw review` or say \"review proposals\" to see them'. Wrap the Redis call in a try/catch so that if Redis is unreachable, the briefing continues without the line. Keep the connection lightweight â€” connect, query, disconnect.",
      "acceptance_criteria": [
        "session-lifecycle/index.ts queries LLEN memory:review:pending from Redis",
        "When count > 0, briefing includes the pending proposals line with the count",
        "When count is 0, no proposal line appears in the briefing",
        "Redis errors are caught and do not block the briefing",
        "TypeScript compiles cleanly: bunx tsc --noEmit in the pi-tools directory"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "MEM-6",
      "title": "Final cleanup: delete REVIEW.md, verify full test suite and no stale references",
      "description": "Delete ~/.joelclaw/workspace/REVIEW.md. Inspect promote-integration.test.ts â€” if it tests REVIEW.md parsing, delete it; if tests are still relevant to the Redis-based flow, update them. Run the full test suite in packages/system-bus (bun test). Run bunx tsc --noEmit. Grep the system-bus source (excluding test files) for any remaining references to REVIEW.md and remove them. Verify joelclaw functions output shows the updated promote function with memory/proposal.approved and memory/proposal.rejected triggers.",
      "acceptance_criteria": [
        "~/.joelclaw/workspace/REVIEW.md does not exist",
        "No references to REVIEW.md remain in non-test source files under packages/system-bus/src (grep confirms)",
        "bun test passes with 0 failures in packages/system-bus",
        "TypeScript compiles cleanly: bunx tsc --noEmit"
      ],
      "priority": 6,
      "passes": false
    }
  ],
  "project": "/Users/joel/Code/joelhooks/joelclaw",
  "workDir": "/Users/joel/Code/joelhooks/joelclaw"
}
