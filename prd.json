{
  "name": "Content Feedback Pipeline",
  "description": "Migrate articles from filesystem MDX to Convex ContentResource, wire the existing review UI to trigger agent edits, and close the feedback loop with cache invalidation.",
  "adrs": [
    "0106",
    "0154",
    "0084",
    "0039"
  ],
  "stories": [
    {
      "id": "CFP-1",
      "title": "Seed articles into Convex ContentResources",
      "priority": 1,
      "status": "done",
      "description": "Write an idempotent seed script that reads all .mdx files from apps/web/content/, parses frontmatter with gray-matter, and upserts each as a ContentResource with type 'article' and resourceId 'article:{slug}'. Fields: slug, title, description, content (MDX body without frontmatter), image, tags, type, date, updated, draft.",
      "acceptance": [
        "Script at scripts/seed-articles.ts runs with `bun scripts/seed-articles.ts`",
        "All .mdx files in apps/web/content/ are upserted to Convex contentResources table",
        "Re-running the script updates existing records (idempotent upsert)",
        "Discoveries in apps/web/content/discoveries/ are NOT included (articles only)",
        "Script logs each article seeded with slug"
      ],
      "files": [
        "scripts/seed-articles.ts",
        "apps/web/convex/contentResources.ts"
      ]
    },
    {
      "id": "CFP-2",
      "title": "Read articles from Convex instead of filesystem",
      "priority": 2,
      "status": "done",
      "description": "Update apps/web/lib/posts.ts so getPost() and getAllPosts() read from Convex via ConvexHttpClient (already at apps/web/lib/convex-content.ts). Keep the existing PostMeta type but add 'image' field. generateStaticParams in app/[slug]/page.tsx should use ConvexHttpClient to list article slugs. Filesystem fallback: if Convex is unreachable, fall back to filesystem reads so the site still builds.\n\nCRITICAL: This story MUST be implemented together with CFP-3 (cache components). Async Convex reads break Next.js 16 PPR prerender without use cache boundaries. The codex agent must add use cache + cacheLife + cacheTag to [slug]/page.tsx in the same changeset.",
      "acceptance": [
        "getPost(slug) queries Convex contentResources for resourceId 'article:{slug}'",
        "getAllPosts() queries Convex contentResources with type 'article', sorted by date desc, excluding drafts",
        "generateStaticParams uses ConvexHttpClient to list slugs",
        "If CONVEX_URL is not set or Convex is unreachable, falls back to filesystem reads",
        "TypeScript compiles clean: bunx tsc --noEmit",
        "Site builds successfully: pnpm --filter web build",
        "Site builds successfully with zero prerender errors: pnpm --filter web build"
      ],
      "files": [
        "apps/web/lib/posts.ts",
        "apps/web/app/[slug]/page.tsx"
      ]
    },
    {
      "id": "CFP-3",
      "title": "Cache components: static shell with cached article content",
      "priority": 3,
      "status": "done",
      "description": "Refactor app/[slug]/page.tsx to use Next.js 16 cache components (PPR). The article content should be in a cached async component with 'use cache', cacheLife('max'), and cacheTag('article:{slug}'). The page shell (header, footer, nav) stays static. FeedbackStatus (future) will be a dynamic Suspense slot. Ensure cacheComponents is enabled in next.config.ts.",
      "acceptance": [
        "next.config.ts has cacheComponents: true",
        "Article content rendered inside a 'use cache' component with cacheTag",
        "Page has Suspense boundary ready for future FeedbackStatus dynamic slot",
        "Site builds with no errors",
        "Article pages still render correctly at /mineclaw, /build-a-voice-agent-that-answers-the-phone"
      ],
      "files": [
        "apps/web/app/[slug]/page.tsx",
        "apps/web/next.config.ts"
      ]
    },
    {
      "id": "CFP-4",
      "title": "Cache invalidation endpoint",
      "priority": 4,
      "status": "done",
      "description": "Create POST /api/revalidate route handler that accepts { tag: string } body, validates a shared secret via x-revalidation-secret header, and calls revalidateTag(tag). Secret comes from REVALIDATION_SECRET env var.",
      "acceptance": [
        "POST /api/revalidate with valid secret and { tag: 'article:mineclaw' } returns { revalidated: true }",
        "Missing or invalid secret returns 401",
        "Missing tag returns 400",
        "TypeScript compiles clean"
      ],
      "files": [
        "apps/web/app/api/revalidate/route.ts"
      ]
    },
    {
      "id": "CFP-5",
      "title": "Inngest function: content/review.submitted handler",
      "priority": 5,
      "status": "done",
      "description": "Create an Inngest function in packages/system-bus that handles 'content/review.submitted' events. Steps: (1) read current article content from Convex, (2) read submitted review comments from Convex, (3) call infer() with content + feedback to produce updated article, (4) validate output is non-empty and similar length to input (±50%), (5) write new contentRevision to Convex, (6) update article contentResource with new content, (7) mark review comments as resolved, (8) POST to /api/revalidate to bust cache tag, (9) notify via gateway. Use concurrency key on resourceId with limit 1.",
      "acceptance": [
        "Function registered as 'content-review-apply' in system-bus worker",
        "Handles content/review.submitted events",
        "Concurrency limited to 1 per resourceId",
        "Uses infer() from packages/system-bus/src/lib/inference.ts (pi session, NOT OpenRouter)",
        "Creates contentRevision record in Convex before overwriting content",
        "Marks review comments as resolved after successful edit",
        "Calls /api/revalidate with correct cache tag",
        "Notifies gateway on completion",
        "Has onFailure handler that resets comment status to 'submitted' and notifies gateway",
        "TypeScript compiles: bunx tsc --noEmit -p packages/system-bus/tsconfig.json"
      ],
      "files": [
        "packages/system-bus/src/inngest/functions/content-review.ts",
        "packages/system-bus/src/inngest/client.ts"
      ]
    },
    {
      "id": "CFP-6",
      "title": "Add feedbackItems and contentRevisions tables to Convex schema",
      "priority": 6,
      "status": "pending",
      "description": "Add feedbackItems table (resourceId, content, status, authorId, createdAt, resolvedAt) and contentRevisions table (resourceId, revisionNumber, content, diff, feedbackIds, agentModel, createdAt) to the Convex schema. Add corresponding mutations: feedback.create, feedback.markProcessing, feedback.markApplied, feedback.markFailed, content.createRevision, content.getRevisions.",
      "acceptance": [
        "feedbackItems table in schema.ts with indexes by_resource and by_resource_status",
        "contentRevisions table in schema.ts with indexes by_resource and by_resource_revision",
        "Mutations for feedback lifecycle (create, markProcessing, markApplied, markFailed)",
        "Mutations for revision lifecycle (createRevision, getRevisions)",
        "npx convex dev deploys without errors"
      ],
      "files": [
        "apps/web/convex/schema.ts",
        "apps/web/convex/feedback.ts",
        "apps/web/convex/contentRevisions.ts"
      ]
    },
    {
      "id": "CFP-7",
      "title": "Wire feedback form to Convex + show processing status",
      "priority": 7,
      "status": "pending",
      "description": "The existing review UI components (components/review/) submit via the existing /api/review/submit route which fires Inngest events. Add a FeedbackStatus client island component that subscribes to Convex feedbackItems for the current article and shows a 'revision in progress' indicator when any feedback has status 'processing'. Use provider island pattern — wrap only FeedbackStatus in ConvexProvider, not the whole page.",
      "acceptance": [
        "FeedbackStatus component shows amber indicator when feedback is processing",
        "Indicator disappears when all feedback is resolved",
        "ConvexProvider is scoped to FeedbackStatus island only, not the layout",
        "Submitting a review via existing UI triggers the full pipeline: Convex → Inngest → agent → revision → cache bust",
        "No regressions on article rendering"
      ],
      "files": [
        "apps/web/components/review/feedback-status.tsx",
        "apps/web/app/[slug]/page.tsx"
      ]
    }
  ],
  "context": {
    "codex_timeout_seconds": 900
  }
}
