Implemented SYNC-1 in `src/inngest/functions/agent-loop/complete.ts:106`.

What changed:
- Kept fast path: `git pull --ff-only` runs first.
- On pull failure, fallback now runs:
  - `git fetch origin`
  - `git reset --hard origin/main`
  - `git clean -fd`
- Kept `bun install --silent` after sync logic, so it runs regardless of fast/fallback path.

Validation:
- `bunx tsc --noEmit` passed (exit code 0).


--- STDERR ---
OpenAI Codex v0.101.0 (research preview)
--------
workdir: /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus
model: gpt-5.3-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: none
reasoning summaries: auto
session id: 019c6bf9-e8a1-7f01-8df4-e1c4fd820dc4
--------
user


## Project File Listing

docker
prd-v3-recovery.json
prd-adr-0010.json
progress.txt
node_modules
prd-retro.json
bun.lock
README.md
package.json
scripts
prd-harden.json
tsconfig.json
docker-compose.yml
prd-v2.json
index.ts
CONTINUATION.md
prd-0026.json
prd.json
start.sh
CLAUDE.md
prd-cli-migration.json
src
CONTINUATION-ADR.md

# src/ files:
src/inngest/client.ts
src/serve.ts

## Project Instructions (CLAUDE.md)


## Agent Loop Architecture (ADR-0015)

This project runs automated coding loops with 5 separated roles:
- **Planner**: generates PRD from goal, picks next story
- **Test Writer**: writes acceptance tests BEFORE implementation (TDD)
- **Implementor**: writes code to pass the tests
- **Reviewer**: evaluates implementation with 4 questions (no test writing)
- **Judge**: mechanical gates + reviewer notes + LLM verdict

When working as an implementor: implement the story, don't write tests.
When working as a test writer: write tests from acceptance criteria only, don't read implementation.
Tests should verify observable behavior and public API — NOT internal structure.
Do NOT use source code string matching (indexOf, regex on source) to verify behavior.
Commit nothing — the harness handles git.

## Bun Runtime

Default to using Bun instead of Node.js.

- Use `bun <file>` instead of `node <file>` or `ts-node <file>`
- Use `bun test` instead of `jest` or `vitest`
- Use `bun build <file.html|file.ts|file.css>` instead of `webpack` or `esbuild`
- Use `bun install` instead of `npm install` or `yarn install` or `pnpm install`
- Use `bun run <script>` instead of `npm run <script>` or `yarn run <script>` or `pnpm run <script>`
- Use `bunx <package> <command>` instead of `npx <package> <command>`
- Bun automatically loads .env, so don't use dotenv.

## APIs

- `Bun.serve()` supports WebSockets, HTTPS, and routes. Don't use `express`.
- `bun:sqlite` for SQLite. Don't use `better-sqlite3`.
- `Bun.redis` for Redis. Don't use `ioredis`.
- `Bun.sql` for Postgres. Don't use `pg` or `postgres.js`.
- `WebSocket` is built-in. Don't use `ws`.
- Prefer `Bun.file` over `node:fs`'s readFile/writeFile
- Bun.$`ls` instead of execa.

## Testing

Use `bun test` to run tests.

```ts#index.test.ts
import { test, expect } from "bun:test";

test("hello world", () => {
  expect(1).toBe(1);
});
```

## Frontend

Use HTML imports with `Bun.serve()`. Don't use `vite`. HTML imports fully support React, C

---

## Story: Make complete.ts worker sync handle dirty state (SYNC-1)

In complete.ts sync-worker-clone step, replace `git pull --ff-only` with a resilient sequence: try `git pull --ff-only` first (fast path), if it fails then `git fetch origin && git reset --hard origin/main && git clean -fd` (nuclear path). The worker clone is never edited directly so hard reset is always safe. Keep `bun install --silent` after either path.

## Acceptance Criteria
- sync-worker-clone tries git pull --ff-only first
- On pull failure, falls back to git fetch + reset --hard origin/main + clean -fd
- bun install --silent runs after sync regardless of path taken
- TypeScript compiles (bunx tsc --noEmit)

## Instructions
Implement the story above. Do NOT write tests — a separate reviewer will handle testing.
Make clean, focused changes. Commit nothing — the harness handles git.
If your changes break existing tests (not just the ones for this story), fix those tests to match the new interface. Changing a type or adding a required field means updating all consumers.
mcp startup: no servers
2026-02-17T14:21:06.234622Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a38-72b9-7fd3-aae0-de7058d752e1
2026-02-17T14:21:06.288951Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5eca-bff9-7772-83bf-5daab07b9959
2026-02-17T14:21:06.374601Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5ffd-d51d-7a13-b1fa-342be02f164b
2026-02-17T14:21:06.452688Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6275-d69e-7b53-bb28-583bfe07e70c
2026-02-17T14:21:06.511333Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6946-d832-73b3-bade-761321c88a0a
2026-02-17T14:21:06.539849Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5d40-288c-78b2-af66-36e0fae54073
2026-02-17T14:21:06.641735Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-25bc-7141-bf68-7df6c001174c
2026-02-17T14:21:06.671003Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a5b-ba72-7f61-8273-d02deacae15e
2026-02-17T14:21:06.715884Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6482-5bab-7e53-bc62-5239d048a3c8
2026-02-17T14:21:06.767801Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a51-1205-7a00-bbdb-509c1624de3d
2026-02-17T14:21:06.841807Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a59-ea9c-73e1-b537-9ad62ea24fd1
2026-02-17T14:21:06.938179Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6485-58f0-7261-8508-37f3fb9356dd
2026-02-17T14:21:07.028849Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c695b-193b-7040-9529-153a24848595
2026-02-17T14:21:07.118194Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6031-b7fb-7120-85b5-8abf34324910
2026-02-17T14:21:07.154814Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fe2-872d-7e93-87a3-71d37d75a127
2026-02-17T14:21:07.189222Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a5d-a9a0-7003-8868-edeb59f5a8e9
2026-02-17T14:21:07.228025Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a4f-9a4d-7c13-aeef-771e0c9a7900
2026-02-17T14:21:07.260821Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5e50-6bc5-7861-a0a0-f77d68ec073f
2026-02-17T14:21:07.386913Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6022-8a12-7ba0-b7e8-9c265e8ec17e
2026-02-17T14:21:07.489340Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fbb-e145-7c40-9913-218548629e57
2026-02-17T14:21:07.551073Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5e21-7a30-7ed1-b686-e02ac2da8157
2026-02-17T14:21:07.673779Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c647c-8066-7eb1-8782-06a844370303
2026-02-17T14:21:07.814889Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-24ce-70e2-a3a9-72ea76928828
2026-02-17T14:21:07.914189Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a58-df8a-7560-894e-8c41ec0bc9ec
2026-02-17T14:21:08.033701Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-ca0f-7153-9527-6336e87fc2d0
2026-02-17T14:21:08.183944Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fed-5e04-78c0-9a4e-9fddc7af084e

thinking
**Planning implementation start**
codex
Implementing SYNC-1 in the worker sync step: I’ll locate `complete.ts`, update the git sync sequence with a fast-path/fallback flow, then run `bunx tsc --noEmit` to verify types compile.
exec
/bin/zsh -lc "rg --files | rg 'complete\\.ts"'$|complete'"'" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-busexec
/bin/zsh -lc 'rg -n "sync-worker-clone|git pull --ff-only|bun install --silent" -S .' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 52ms:
src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts
src/inngest/functions/agent-loop/complete.ts
 succeeded in 52ms:
./start.sh:15:cd "$REPO_ROOT" && bun install --silent 2>&1 || echo "WARNING: bun install failed" >&2
./prd.json:21:      "description": "In complete.ts sync-worker-clone step, replace `git pull --ff-only` with a resilient sequence: try `git pull --ff-only` first (fast path), if it fails then `git fetch origin && git reset --hard origin/main && git clean -fd` (nuclear path). The worker clone is never edited directly so hard reset is always safe. Keep `bun install --silent` after either path.",
./prd.json:23:        "sync-worker-clone tries git pull --ff-only first",
./prd.json:25:        "bun install --silent runs after sync regardless of path taken",
./prd-harden.json:8:      "complete.ts sync-worker-clone step hardcodes system-bus path — should be conditional on project",
./prd-harden.json:33:      "title": "Make sync-worker-clone conditional on project path",
./prd-harden.json:34:      "description": "The sync-worker-clone step in complete.ts should only run when the project path contains 'joelclaw' or 'system-bus'. For other projects (igs, pi-tools), skip the sync step. Currently it tries to sync for all projects which is harmless but logs confusing errors.",
./prd-harden.json:36:        "sync-worker-clone only runs for system-bus/joelclaw projects",
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:119:  test("AC-1 + AC-3: sync-worker-clone tries git pull --ff-only first and still runs bun install on success path", async () => {
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:123:        if (command.includes("git pull --ff-only")) return { exitCode: 0 };
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:124:        if (command.includes("bun install --silent")) return { exitCode: 0 };
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:142:            passthroughRunIds: ["sync-worker-clone"],
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:152:        expect(runCalls).toContain("sync-worker-clone");
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:154:        const pullIndex = calls.findIndex((c) => c.includes("git pull --ff-only"));
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:155:        const installIndex = calls.findIndex((c) => c.includes("bun install --silent"));
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:171:        if (command.includes("git pull --ff-only")) {
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:177:        if (command.includes("bun install --silent")) return { exitCode: 0 };
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:193:            passthroughRunIds: ["sync-worker-clone"],
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:202:        const pullIndex = calls.findIndex((c) => c.includes("git pull --ff-only"));
./src/inngest/functions/agent-loop/complete-sync-worker-clone.test.ts:206:        const installIndex = calls.findIndex((c) => c.includes("bun install --silent"));
codex
I found the target block in `src/inngest/functions/agent-loop/complete.ts`; next I’m editing that step to add the fallback fetch/reset/clean flow while preserving install behavior.
exec
/bin/zsh -lc "sed -n '1,220p' src/inngest/functions/agent-loop/complete.ts" in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 53ms:
import { inngest } from "../../client";
import { $ } from "bun";
import { mintGitHubToken } from "./utils";

/**
 * COMPLETER — Handles agent/loop.complete events.
 * Merges the worktree branch back to main, then optionally pushes to remote.
 */
export const agentLoopComplete = inngest.createFunction(
  {
    id: "agent-loop-complete",
    cancelOn: [
      {
        event: "agent/loop.cancelled",
        if: "event.data.loopId == async.data.loopId",
      },
    ],
  },
  [{ event: "agent/loop.completed" }],
  async ({ event, step }) => {

thinking
**Adjusting fallback with clean -fd**
codex
I’m applying a focused edit in `complete.ts` now: add `git clean -fd` to the fallback command and keep `bun install --silent` unconditional after sync attempts.
file update
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -108,4 +108,6 @@
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
apply_patch(auto_approved=true) exited 0 in 40ms:
Success. Updated the following files:
M /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
index 3ff24ecbec7ece613e203c99b055678eb15bed64..6288877c33c67978ba47dd9ab515e711bc5b025c
--- a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -106,8 +106,10 @@
           // Pull from monorepo (worker's origin)
           const pull = await $`cd ${workerRoot} && git pull --ff-only`.quiet().nothrow();
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
           // Install deps in case new packages were added
           await $`cd ${workerRoot} && bun install --silent`.quiet().nothrow();

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
index 3ff24ecbec7ece613e203c99b055678eb15bed64..6288877c33c67978ba47dd9ab515e711bc5b025c
--- a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -106,8 +106,10 @@
           // Pull from monorepo (worker's origin)
           const pull = await $`cd ${workerRoot} && git pull --ff-only`.quiet().nothrow();
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
           // Install deps in case new packages were added
           await $`cd ${workerRoot} && bun install --silent`.quiet().nothrow();


thinking
**Planning type check run**
codex
The sync logic change is in place. I’m running TypeScript compile checks now with `bunx tsc --noEmit` to confirm acceptance criteria.
exec
/bin/zsh -lc 'bunx tsc --noEmit' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 2.86s:

file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
index 3ff24ecbec7ece613e203c99b055678eb15bed64..6288877c33c67978ba47dd9ab515e711bc5b025c
--- a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -106,8 +106,10 @@
           // Pull from monorepo (worker's origin)
           const pull = await $`cd ${workerRoot} && git pull --ff-only`.quiet().nothrow();
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
           // Install deps in case new packages were added
           await $`cd ${workerRoot} && bun install --silent`.quiet().nothrow();

exec
/bin/zsh -lc 'git diff -- src/inngest/functions/agent-loop/complete.ts' in /private/tmp/agent-loop/loop-mlqojz0v-7nnrle/packages/system-bus succeeded in 440ms:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
index 3ff24ec..6288877 100644
--- a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -106,8 +106,10 @@ export const agentLoopComplete = inngest.createFunction(
           // Pull from monorepo (worker's origin)
           const pull = await $`cd ${workerRoot} && git pull --ff-only`.quiet().nothrow();
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
           // Install deps in case new packages were added
           await $`cd ${workerRoot} && bun install --silent`.quiet().nothrow();
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
index 3ff24ecbec7ece613e203c99b055678eb15bed64..6288877c33c67978ba47dd9ab515e711bc5b025c
--- a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -106,8 +106,10 @@
           // Pull from monorepo (worker's origin)
           const pull = await $`cd ${workerRoot} && git pull --ff-only`.quiet().nothrow();
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
           // Install deps in case new packages were added
           await $`cd ${workerRoot} && bun install --silent`.quiet().nothrow();


thinking
**Summarizing include criteria and test status**
codex
Implemented SYNC-1 in `src/inngest/functions/agent-loop/complete.ts:106`.

What changed:
- Kept fast path: `git pull --ff-only` runs first.
- On pull failure, fallback now runs:
  - `git fetch origin`
  - `git reset --hard origin/main`
  - `git clean -fd`
- Kept `bun install --silent` after sync logic, so it runs regardless of fast/fallback path.

Validation:
- `bunx tsc --noEmit` passed (exit code 0).
file update:
diff --git a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
index 3ff24ecbec7ece613e203c99b055678eb15bed64..6288877c33c67978ba47dd9ab515e711bc5b025c
--- a/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
+++ b/packages/system-bus/src/inngest/functions/agent-loop/complete.ts
@@ -106,8 +106,10 @@
           // Pull from monorepo (worker's origin)
           const pull = await $`cd ${workerRoot} && git pull --ff-only`.quiet().nothrow();
           if (pull.exitCode !== 0) {
-            // If not fast-forward, reset to origin/main
-            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main`.quiet().nothrow();
+            // If not fast-forward, force-sync worker clone from origin/main
+            await $`cd ${workerRoot} && git fetch origin && git reset --hard origin/main && git clean -fd`
+              .quiet()
+              .nothrow();
           }
           // Install deps in case new packages were added
           await $`cd ${workerRoot} && bun install --silent`.quiet().nothrow();

tokens used
15,708
