Implemented FRIC-4 in `packages/system-bus/src/inngest/functions/heartbeat.ts`.

### What changed
- Added a new heartbeat step: `step.run("prune-old-sessions", ...)` in both:
  - `heartbeatCron` (`packages/system-bus/src/inngest/functions/heartbeat.ts:92`)
  - `heartbeatWake` (`packages/system-bus/src/inngest/functions/heartbeat.ts:110`)
- Added pruning logic to:
  - Recursively scan `~/.pi/agent/sessions/` and only target `.jsonl` files (`packages/system-bus/src/inngest/functions/heartbeat.ts:69-71`)
  - Recursively scan `~/.claude/debug/` for files (`packages/system-bus/src/inngest/functions/heartbeat.ts:71`)
  - Delete files with `mtime` older than 30 days (`packages/system-bus/src/inngest/functions/heartbeat.ts:37-62`)
- Step output now includes counts:
  - `prunedCount`
  - `prunedSessionsCount`
  - `prunedDebugCount`
  (`packages/system-bus/src/inngest/functions/heartbeat.ts:83`)
- Added logging for the prune step count (`packages/system-bus/src/inngest/functions/heartbeat.ts:77`).

### Verification
- Ran `bunx tsc --noEmit` at repo root.
- Result: passed (exit code `0`).


--- STDERR ---
OpenAI Codex v0.101.0 (research preview)
--------
workdir: /private/tmp/agent-loop/loop-mlreb9au-bvjrl0
model: gpt-5.3-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: none
reasoning summaries: auto
session id: 019c6e96-74ca-7b10-a17f-ddff923c6e53
--------
user


## Project File Listing

pnpm-lock.yaml
infra
FRIC-2-1.out
vercel.json
k8s
turbo.json
node_modules
FRIC-1-1.out
FRIC-1-2.out
bun.lock
docs
friction-prd.json
FRIC-3-1.out
README.md
package.json
scripts
packages
tsconfig.json
prd.json
apps
Vault
pnpm-workspace.yaml

---

## Story: Add session file pruning to system heartbeat (FRIC-4)

~/.pi/agent/sessions/ is 45MB and growing. Add a prune-old-sessions step to the existing heartbeat function. Find all .jsonl files recursively in ~/.pi/agent/sessions/, delete any with mtime older than 30 days. Log the count. Also prune ~/.claude/debug/ files older than 30 days.

## Acceptance Criteria
- Heartbeat has a prune-old-sessions step
- Files older than 30 days are deleted
- Files newer than 30 days are NOT deleted
- Count of pruned files is in step output
- bunx tsc --noEmit passes

## Instructions
Implement the story above. Do NOT write tests — a separate reviewer will handle testing.
Make clean, focused changes. Commit nothing — the harness handles git.
If your changes break existing tests (not just the ones for this story), fix those tests to match the new interface. Changing a type or adding a required field means updating all consumers.
mcp startup: no servers
2026-02-18T02:31:20.068982Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6d78-f4bd-70a3-9b26-6d401f72555d
2026-02-18T02:31:20.113923Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a38-72b9-7fd3-aae0-de7058d752e1
2026-02-18T02:31:20.149879Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6dfc-ce2b-7351-9877-3cf3dfd942e0
2026-02-18T02:31:20.242820Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5ffd-d51d-7a13-b1fa-342be02f164b
2026-02-18T02:31:20.272369Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6275-d69e-7b53-bb28-583bfe07e70c
2026-02-18T02:31:20.331272Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6d76-b1ac-7312-a2bc-33ed66270397
2026-02-18T02:31:20.420288Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6946-d832-73b3-bade-761321c88a0a
2026-02-18T02:31:20.527046Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6d85-da78-7b62-99df-11a605673333
2026-02-18T02:31:20.640975Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-25bc-7141-bf68-7df6c001174c
2026-02-18T02:31:20.753637Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a5b-ba72-7f61-8273-d02deacae15e
2026-02-18T02:31:20.859946Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6482-5bab-7e53-bc62-5239d048a3c8
2026-02-18T02:31:20.981356Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a51-1205-7a00-bbdb-509c1624de3d
2026-02-18T02:31:21.108311Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a59-ea9c-73e1-b537-9ad62ea24fd1
2026-02-18T02:31:21.199379Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6d85-394c-7a22-a0ba-b3f326504c0f
2026-02-18T02:31:21.313386Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6485-58f0-7261-8508-37f3fb9356dd
2026-02-18T02:31:21.453003Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6e00-a005-7611-9e9c-4eb489c27876
2026-02-18T02:31:21.535152Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c695b-193b-7040-9529-153a24848595
2026-02-18T02:31:21.618709Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6e06-ec09-76c2-885f-2d09d13a2034
2026-02-18T02:31:21.736963Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6031-b7fb-7120-85b5-8abf34324910
2026-02-18T02:31:21.863415Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fe2-872d-7e93-87a3-71d37d75a127
2026-02-18T02:31:21.972134Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6d46-f863-7a62-8f46-d697792894dd
2026-02-18T02:31:22.041095Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a5d-a9a0-7003-8868-edeb59f5a8e9
2026-02-18T02:31:22.076626Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a4f-9a4d-7c13-aeef-771e0c9a7900
2026-02-18T02:31:22.229246Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6e83-f754-78e0-91ab-9f35f5d158a3
2026-02-18T02:31:22.320328Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6022-8a12-7ba0-b7e8-9c265e8ec17e
2026-02-18T02:31:22.420299Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fbb-e145-7c40-9913-218548629e57
2026-02-18T02:31:22.553668Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c647c-8066-7eb1-8782-06a844370303
2026-02-18T02:31:22.611409Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-24ce-70e2-a3a9-72ea76928828
2026-02-18T02:31:22.736979Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6a58-df8a-7560-894e-8c41ec0bc9ec
2026-02-18T02:31:22.880672Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6bed-ca0f-7153-9527-6336e87fc2d0
2026-02-18T02:31:23.029656Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c5fed-5e04-78c0-9a4e-9fddc7af084e
2026-02-18T02:31:23.174324Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6d75-a627-7be2-a5b9-708ae8d9ac39
2026-02-18T02:31:23.286988Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6e13-228a-7cb2-a82d-b195be95b007
2026-02-18T02:31:23.401115Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6df8-e840-70b1-8ca3-7f1dc55b0796

thinking
**Planning code exploration strategy**
codex
I’m implementing FRIC-4 by locating the existing heartbeat workflow first, then I’ll add a focused prune step for old `.jsonl` sessions and old `~/.claude/debug` files with count logging, and run `bunx tsc --noEmit` to verify types.
exec
/bin/zsh -lc 'rg --files . | rg -n "heartbeat|health|monitor|pulse|system"' in /private/tmp/agent-loop/loop-mlreb9au-bvjrl0exec
/bin/zsh -lc 'rg -n "heartbeat|HeartBeat|system heartbeat|heartbeat" -S .' in /private/tmp/agent-loop/loop-mlreb9au-bvjrl0 succeeded in 53ms:
2:./Vault/docs/decisions/0010-system-loop-gateway.md
40:./apps/web/content/adrs/0010-system-loop-gateway.md
58:./apps/web/content/adrs/0033-victoriametrics-grafana-monitoring-stack.md
66:./apps/web/content/adrs/0022-webhook-to-system-event-pipeline.md
73:./apps/web/content/adrs/0021-agent-memory-system.md
75:./apps/web/content/adrs/0002-personal-assistant-system-architecture.md
80:./apps/web/content/inngest-is-the-nervous-system.mdx
128:./packages/gateway/src/heartbeat.ts
136:./packages/system-bus/CONTINUATION-ADR.md
137:./packages/system-bus/src/serve.ts
138:./packages/system-bus/src/inngest/client.test.ts
139:./packages/system-bus/src/inngest/functions/embed.ts
140:./packages/system-bus/src/inngest/functions/transcript-process.ts
141:./packages/system-bus/src/inngest/functions/content-sync.ts
142:./packages/system-bus/src/inngest/functions/index.ts
143:./packages/system-bus/src/inngest/functions/video-download.ts
144:./packages/system-bus/src/inngest/functions/promote.test.ts
145:./packages/system-bus/src/inngest/functions/discovery-capture.ts
146:./packages/system-bus/src/inngest/functions/heartbeat.test.ts
147:./packages/system-bus/src/inngest/functions/promote.ts
 succeeded in 53ms:
./Vault/docs/decisions/0010-system-loop-gateway.md:36:### Option B: Cron-triggered heartbeat — Inngest cron function that runs every N minutes and checks state
./Vault/docs/decisions/0010-system-loop-gateway.md:50:Chosen option: **Hybrid of Option C + Option B**. The gateway will use an event-driven reactive loop as the primary control path, triggered by high-signal events such as `agent/loop.complete`, `agent/loop.retro.complete`, and `system/note`. A cron heartbeat sweep every 15-30 minutes will run as a fallback to catch missed events, reconcile drift, and unblock stuck work.
./Vault/docs/decisions/0010-system-loop-gateway.md:59:- The note queue gets processed more consistently because the fallback heartbeat sweep closes event-delivery gaps.
./Vault/docs/decisions/0010-system-loop-gateway.md:88:### Option B: Cron-triggered heartbeat — Inngest cron function that runs every N minutes and checks state
./Vault/docs/decisions/0010-system-loop-gateway.md:126:1. Build a new Inngest gateway function `system/heartbeat` that can be invoked from two trigger paths: (a) cron schedule every 15-30 minutes and (b) terminal events such as `agent/loop.complete`, `agent/loop.retro.complete`, and `system/note`.
./Vault/docs/decisions/0010-system-loop-gateway.md:135:- [ ] Triggering `system/heartbeat` from cron and from a terminal event both execute the same decision pipeline and produce a run log with the trigger source.
./apps/web/content/adrs/0010-system-loop-gateway.md:38:### Option B: Cron-triggered heartbeat — Inngest cron function that runs every N minutes and checks state
./apps/web/content/adrs/0010-system-loop-gateway.md:52:Chosen option: **Hybrid of Option C + Option B**. The gateway will use an event-driven reactive loop as the primary control path, triggered by high-signal events such as `agent/loop.complete`, `agent/loop.retro.complete`, and `system/note`. A cron heartbeat sweep every 15-30 minutes will run as a fallback to catch missed events, reconcile drift, and unblock stuck work.
./apps/web/content/adrs/0010-system-loop-gateway.md:61:- The note queue gets processed more consistently because the fallback heartbeat sweep closes event-delivery gaps.
./apps/web/content/adrs/0010-system-loop-gateway.md:90:### Option B: Cron-triggered heartbeat — Inngest cron function that runs every N minutes and checks state
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:16:ADR-0018 established a Redis event bridge between Inngest functions and pi sessions. The initial implementation pushed every event to a single shared `joelclaw:events:main` list. This worked for one session but breaks with multiple concurrent pi sessions — every session receives every heartbeat, events are drained by whichever session reads first (race condition), and context budgets are wasted on irrelevant notifications.
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:18:Joel often runs 3-5 pi sessions simultaneously (different terminals, different tasks). A heartbeat cron firing every 15 minutes shouldn't interrupt a coding session — it should go to the session responsible for system oversight.
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:22:OpenClaw uses a **single-session model**. One Node.js process owns the LLM session. All inputs — TUI commands, heartbeat prompts, channel messages (Telegram, Discord, WhatsApp, web) — serialize through a single `CommandLane.Main` queue into that one session.
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:26:The heartbeat is a `setInterval` timer inside the gateway process that reads `HEARTBEAT.md`, drains an in-memory event queue, builds a prompt, and injects it. `HEARTBEAT_OK` responses are filtered/suppressed.
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:44:| **Central** | `gateway` | ALL events (heartbeats, task completions, system alerts) | Always-on system oversight session |
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:49:1. **Heartbeats** (`cron.heartbeat`) → central session only
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:77:Simple but wasteful. Every session gets every heartbeat, every loop completion. Context budgets are finite — a coding session shouldn't burn tokens on heartbeat checklists.
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:96:- Stale session cleanup is best-effort (PID-based, no heartbeat/lease)
./apps/web/content/adrs/0035-gateway-session-routing-central-satellite.md:135:- [ ] Central session receives heartbeats, satellites do not
./apps/web/content/adrs/0018-pi-native-gateway-redis-event-bridge.md:20:ADR-0010 established the need for a central system loop gateway — an autonomous orchestrator that runs SENSE→ORIENT→DECIDE→ACT→LEARN and chose a hybrid event-driven + cron heartbeat approach. It left implementation open.

thinking
**Inspecting heartbeat and tests**
codex
I found the target function at `packages/system-bus/src/inngest/functions/heartbeat.ts`; next I’m reading it (and its existing heartbeat test) to integrate pruning in the current step pattern without widening scope.
exec
/bin/zsh -lc "sed -n '1,240p' packages/system-bus/src/inngest/functions/heartbeat.ts" in /private/tmp/agent-loop/loop-mlreb9au-bvjrl0exec
/bin/zsh -lc "sed -n '1,260p' packages/system-bus/src/inngest/functions/heartbeat.test.ts" in /private/tmp/agent-loop/loop-mlreb9au-bvjrl0 succeeded in 51ms:
import { inngest } from "../client";
import { pushGatewayEvent } from "./agent-loop/utils";

export const heartbeatCron = inngest.createFunction(
  {
    id: "system-heartbeat",
  },
  [{ cron: "*/15 * * * *" }],
  async ({ step }) => {
    await step.run("push-gateway-event", async () => {
      await pushGatewayEvent({
        type: "cron.heartbeat",
        source: "inngest",
        payload: {},
      });
    });
  }
);

export const heartbeatWake = inngest.createFunction(
 succeeded in 51ms:
import { afterAll, afterEach, beforeAll, beforeEach, describe, expect, test } from "bun:test";
import { InngestTestEngine } from "@inngest/test";
import Redis from "ioredis";
import {
  existsSync,
  mkdirSync,
  mkdtempSync,
  rmSync,
  utimesSync,
  writeFileSync,
} from "node:fs";
import { tmpdir } from "node:os";
import { dirname, join } from "node:path";
import { heartbeatCron } from "./heartbeat";

const originalHome = process.env.HOME;
const originalUserProfile = process.env.USERPROFILE;
const originalRedisMethods = {
  smembers: Redis.prototype.smembers,
  lpush: Redis.prototype.lpush,

thinking
**Planning recursive pruning implementation**
codex
I confirmed there’s already an acceptance-style heartbeat test expecting a `prune-old-sessions` step, so I’m now editing `heartbeat.ts` to add exactly that step with recursive file pruning and a numeric count in the step result.
file update
M /private/tmp/agent-loop/loop-mlreb9au-bvjrl0/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -2,3 +2,63 @@
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
 
+  return prunedCount;
+}
+
 export const heartbeatCron = inngest.createFunction(
@@ -9,2 +69,24 @@
   async ({ step }) => {
+    await step.run("prune-old-sessions", async () => {
+      const home = getHomeDirectory();
+      const sessionsDir = join(home, ".pi", "agent", "sessions");
+      const claudeDebugDir = join(home, ".claude", "debug");
+
+      const sessionFiles = await collectFilesRecursively(sessionsDir);
+      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+      const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+      const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+      console.log("[heartbeat] prune-old-sessions", {
+        prunedCount,
+        prunedSessionsCount,
+        prunedDebugCount,
+      });
+
+      return { prunedCount, prunedSessionsCount, prunedDebugCount };
+    });
+
     await step.run("push-gateway-event", async () => {
@@ -25,2 +107,24 @@
   async ({ step }) => {
+    await step.run("prune-old-sessions", async () => {
+      const home = getHomeDirectory();
+      const sessionsDir = join(home, ".pi", "agent", "sessions");
+      const claudeDebugDir = join(home, ".claude", "debug");
+
+      const sessionFiles = await collectFilesRecursively(sessionsDir);
+      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+      const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+      const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+      console.log("[heartbeat] prune-old-sessions", {
+        prunedCount,
+        prunedSessionsCount,
+        prunedDebugCount,
+      });
+
+      return { prunedCount, prunedSessionsCount, prunedDebugCount };
+    });
+
     await step.run("push-gateway-event", async () => {
apply_patch(auto_approved=true) exited 0 in 34ms:
Success. Updated the following files:
M /private/tmp/agent-loop/loop-mlreb9au-bvjrl0/packages/system-bus/src/inngest/functions/heartbeat.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..9f1d1f582fe85a21f5c695f50d04331b9026260e
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,94 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
 
+  return prunedCount;
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", async () => {
+      const home = getHomeDirectory();
+      const sessionsDir = join(home, ".pi", "agent", "sessions");
+      const claudeDebugDir = join(home, ".claude", "debug");
+
+      const sessionFiles = await collectFilesRecursively(sessionsDir);
+      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+      const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+      const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+      console.log("[heartbeat] prune-old-sessions", {
+        prunedCount,
+        prunedSessionsCount,
+        prunedDebugCount,
+      });
+
+      return { prunedCount, prunedSessionsCount, prunedDebugCount };
+    });
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +105,28 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", async () => {
+      const home = getHomeDirectory();
+      const sessionsDir = join(home, ".pi", "agent", "sessions");
+      const claudeDebugDir = join(home, ".claude", "debug");
+
+      const sessionFiles = await collectFilesRecursively(sessionsDir);
+      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+      const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+      const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+      console.log("[heartbeat] prune-old-sessions", {
+        prunedCount,
+        prunedSessionsCount,
+        prunedDebugCount,
+      });
+
+      return { prunedCount, prunedSessionsCount, prunedDebugCount };
+    });
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",

file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..9f1d1f582fe85a21f5c695f50d04331b9026260e
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,94 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
 
+  return prunedCount;
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", async () => {
+      const home = getHomeDirectory();
+      const sessionsDir = join(home, ".pi", "agent", "sessions");
+      const claudeDebugDir = join(home, ".claude", "debug");
+
+      const sessionFiles = await collectFilesRecursively(sessionsDir);
+      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+      const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+      const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+      console.log("[heartbeat] prune-old-sessions", {
+        prunedCount,
+        prunedSessionsCount,
+        prunedDebugCount,
+      });
+
+      return { prunedCount, prunedSessionsCount, prunedDebugCount };
+    });
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +105,28 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", async () => {
+      const home = getHomeDirectory();
+      const sessionsDir = join(home, ".pi", "agent", "sessions");
+      const claudeDebugDir = join(home, ".claude", "debug");
+
+      const sessionFiles = await collectFilesRecursively(sessionsDir);
+      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+      const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+      const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+      console.log("[heartbeat] prune-old-sessions", {
+        prunedCount,
+        prunedSessionsCount,
+        prunedDebugCount,
+      });
+
+      return { prunedCount, prunedSessionsCount, prunedDebugCount };
+    });
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",


thinking
**Refactoring prune step for reuse**
codex
I’ve added the pruning logic; I’m doing one cleanup pass now to remove duplication between cron and wake handlers so the change stays maintainable.
file update
M /private/tmp/agent-loop/loop-mlreb9au-bvjrl0/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -63,2 +63,24 @@
 
+async function pruneOldSessionFiles() {
+  const home = getHomeDirectory();
+  const sessionsDir = join(home, ".pi", "agent", "sessions");
+  const claudeDebugDir = join(home, ".claude", "debug");
+
+  const sessionFiles = await collectFilesRecursively(sessionsDir);
+  const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+  const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+  const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+  const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+  const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+  console.log("[heartbeat] prune-old-sessions", {
+    prunedCount,
+    prunedSessionsCount,
+    prunedDebugCount,
+  });
+
+  return { prunedCount, prunedSessionsCount, prunedDebugCount };
+}
+
 export const heartbeatCron = inngest.createFunction(
@@ -69,24 +91,4 @@
   async ({ step }) => {
-    await step.run("prune-old-sessions", async () => {
-      const home = getHomeDirectory();
-      const sessionsDir = join(home, ".pi", "agent", "sessions");
-      const claudeDebugDir = join(home, ".claude", "debug");
-
-      const sessionFiles = await collectFilesRecursively(sessionsDir);
-      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
-      const debugFiles = await collectFilesRecursively(claudeDebugDir);
-
-      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
-      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
-      const prunedCount = prunedSessionsCount + prunedDebugCount;
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
 
-      console.log("[heartbeat] prune-old-sessions", {
-        prunedCount,
-        prunedSessionsCount,
-        prunedDebugCount,
-      });
-
-      return { prunedCount, prunedSessionsCount, prunedDebugCount };
-    });
-
     await step.run("push-gateway-event", async () => {
@@ -107,23 +109,3 @@
   async ({ step }) => {
-    await step.run("prune-old-sessions", async () => {
-      const home = getHomeDirectory();
-      const sessionsDir = join(home, ".pi", "agent", "sessions");
-      const claudeDebugDir = join(home, ".claude", "debug");
-
-      const sessionFiles = await collectFilesRecursively(sessionsDir);
-      const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
-      const debugFiles = await collectFilesRecursively(claudeDebugDir);
-
-      const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
-      const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
-      const prunedCount = prunedSessionsCount + prunedDebugCount;
-
-      console.log("[heartbeat] prune-old-sessions", {
-        prunedCount,
-        prunedSessionsCount,
-        prunedDebugCount,
-      });
-
-      return { prunedCount, prunedSessionsCount, prunedDebugCount };
-    });
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
 
apply_patch(auto_approved=true) exited 0 in 46ms:
Success. Updated the following files:
M /private/tmp/agent-loop/loop-mlreb9au-bvjrl0/packages/system-bus/src/inngest/functions/heartbeat.ts
file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..c551867a669a7a6151ffd29fa6f7cf772c8c1020
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,96 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
+
+  return prunedCount;
+}
+
+async function pruneOldSessionFiles() {
+  const home = getHomeDirectory();
+  const sessionsDir = join(home, ".pi", "agent", "sessions");
+  const claudeDebugDir = join(home, ".claude", "debug");
 
+  const sessionFiles = await collectFilesRecursively(sessionsDir);
+  const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+  const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+  const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+  const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+  const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+  console.log("[heartbeat] prune-old-sessions", {
+    prunedCount,
+    prunedSessionsCount,
+    prunedDebugCount,
+  });
+
+  return { prunedCount, prunedSessionsCount, prunedDebugCount };
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +107,8 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",

file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..c551867a669a7a6151ffd29fa6f7cf772c8c1020
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,96 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
+
+  return prunedCount;
+}
+
+async function pruneOldSessionFiles() {
+  const home = getHomeDirectory();
+  const sessionsDir = join(home, ".pi", "agent", "sessions");
+  const claudeDebugDir = join(home, ".claude", "debug");
 
+  const sessionFiles = await collectFilesRecursively(sessionsDir);
+  const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+  const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+  const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+  const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+  const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+  console.log("[heartbeat] prune-old-sessions", {
+    prunedCount,
+    prunedSessionsCount,
+    prunedDebugCount,
+  });
+
+  return { prunedCount, prunedSessionsCount, prunedDebugCount };
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +107,8 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",


thinking
**Running type check at root**
codex
I’ve finished the code change; next I’m running the requested typecheck (`bunx tsc --noEmit`) to validate the repo still compiles with the new heartbeat step.
exec
/bin/zsh -lc 'bunx tsc --noEmit' in /private/tmp/agent-loop/loop-mlreb9au-bvjrl0 succeeded in 482ms:

file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..c551867a669a7a6151ffd29fa6f7cf772c8c1020
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,96 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
+
+  return prunedCount;
+}
+
+async function pruneOldSessionFiles() {
+  const home = getHomeDirectory();
+  const sessionsDir = join(home, ".pi", "agent", "sessions");
+  const claudeDebugDir = join(home, ".claude", "debug");
 
+  const sessionFiles = await collectFilesRecursively(sessionsDir);
+  const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+  const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+  const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+  const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+  const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+  console.log("[heartbeat] prune-old-sessions", {
+    prunedCount,
+    prunedSessionsCount,
+    prunedDebugCount,
+  });
+
+  return { prunedCount, prunedSessionsCount, prunedDebugCount };
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +107,8 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",


thinking
**Clarifying skill mention approach**
exec
/bin/zsh -lc "nl -ba packages/system-bus/src/inngest/functions/heartbeat.ts | sed -n '1,240p'" in /private/tmp/agent-loop/loop-mlreb9au-bvjrl0 succeeded in 53ms:
     1	import { inngest } from "../client";
     2	import { pushGatewayEvent } from "./agent-loop/utils";
     3	import { readdir, rm, stat } from "node:fs/promises";
     4	import { join } from "node:path";
     5	import { homedir } from "node:os";
     6	
     7	const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
     8	
     9	function getHomeDirectory(): string {
    10	  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
    11	}
    12	
    13	async function collectFilesRecursively(rootDir: string): Promise<string[]> {
    14	  const files: string[] = [];
    15	  let entries: Awaited<ReturnType<typeof readdir>>;
    16	
    17	  try {
    18	    entries = await readdir(rootDir, { withFileTypes: true });
    19	  } catch {
    20	    return files;
file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..c551867a669a7a6151ffd29fa6f7cf772c8c1020
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,96 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
+
+  return prunedCount;
+}
+
+async function pruneOldSessionFiles() {
+  const home = getHomeDirectory();
+  const sessionsDir = join(home, ".pi", "agent", "sessions");
+  const claudeDebugDir = join(home, ".claude", "debug");
 
+  const sessionFiles = await collectFilesRecursively(sessionsDir);
+  const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+  const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+  const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+  const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+  const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+  console.log("[heartbeat] prune-old-sessions", {
+    prunedCount,
+    prunedSessionsCount,
+    prunedDebugCount,
+  });
+
+  return { prunedCount, prunedSessionsCount, prunedDebugCount };
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +107,8 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",


thinking
**Confirming build-only check**
codex
Implemented FRIC-4 in `packages/system-bus/src/inngest/functions/heartbeat.ts`.

### What changed
- Added a new heartbeat step: `step.run("prune-old-sessions", ...)` in both:
  - `heartbeatCron` (`packages/system-bus/src/inngest/functions/heartbeat.ts:92`)
  - `heartbeatWake` (`packages/system-bus/src/inngest/functions/heartbeat.ts:110`)
- Added pruning logic to:
  - Recursively scan `~/.pi/agent/sessions/` and only target `.jsonl` files (`packages/system-bus/src/inngest/functions/heartbeat.ts:69-71`)
  - Recursively scan `~/.claude/debug/` for files (`packages/system-bus/src/inngest/functions/heartbeat.ts:71`)
  - Delete files with `mtime` older than 30 days (`packages/system-bus/src/inngest/functions/heartbeat.ts:37-62`)
- Step output now includes counts:
  - `prunedCount`
  - `prunedSessionsCount`
  - `prunedDebugCount`
  (`packages/system-bus/src/inngest/functions/heartbeat.ts:83`)
- Added logging for the prune step count (`packages/system-bus/src/inngest/functions/heartbeat.ts:77`).

### Verification
- Ran `bunx tsc --noEmit` at repo root.
- Result: passed (exit code `0`).
file update:
diff --git a/packages/system-bus/src/inngest/functions/heartbeat.ts b/packages/system-bus/src/inngest/functions/heartbeat.ts
index 2892509ec136f9a1118f2db9fa2c84b5c506e5b8..c551867a669a7a6151ffd29fa6f7cf772c8c1020
--- a/packages/system-bus/src/inngest/functions/heartbeat.ts
+++ b/packages/system-bus/src/inngest/functions/heartbeat.ts
@@ -1,12 +1,96 @@
 import { inngest } from "../client";
 import { pushGatewayEvent } from "./agent-loop/utils";
+import { readdir, rm, stat } from "node:fs/promises";
+import { join } from "node:path";
+import { homedir } from "node:os";
+
+const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
+
+function getHomeDirectory(): string {
+  return process.env.HOME ?? process.env.USERPROFILE ?? homedir();
+}
+
+async function collectFilesRecursively(rootDir: string): Promise<string[]> {
+  const files: string[] = [];
+  let entries: Awaited<ReturnType<typeof readdir>>;
+
+  try {
+    entries = await readdir(rootDir, { withFileTypes: true });
+  } catch {
+    return files;
+  }
+
+  for (const entry of entries) {
+    const fullPath = join(rootDir, entry.name);
+    if (entry.isDirectory()) {
+      files.push(...(await collectFilesRecursively(fullPath)));
+      continue;
+    }
+    if (entry.isFile()) {
+      files.push(fullPath);
+    }
+  }
+
+  return files;
+}
+
+async function pruneOldFiles(paths: string[], olderThanMs: number): Promise<number> {
+  const threshold = Date.now() - olderThanMs;
+  let prunedCount = 0;
+
+  for (const path of paths) {
+    let fileStat: Awaited<ReturnType<typeof stat>>;
+    try {
+      fileStat = await stat(path);
+    } catch {
+      continue;
+    }
+
+    if (fileStat.mtimeMs >= threshold) {
+      continue;
+    }
+
+    try {
+      await rm(path, { force: true });
+      prunedCount += 1;
+    } catch {
+      // Ignore best-effort cleanup failures.
+    }
+  }
+
+  return prunedCount;
+}
+
+async function pruneOldSessionFiles() {
+  const home = getHomeDirectory();
+  const sessionsDir = join(home, ".pi", "agent", "sessions");
+  const claudeDebugDir = join(home, ".claude", "debug");
 
+  const sessionFiles = await collectFilesRecursively(sessionsDir);
+  const oldSessionJsonlPaths = sessionFiles.filter((filePath) => filePath.endsWith(".jsonl"));
+  const debugFiles = await collectFilesRecursively(claudeDebugDir);
+
+  const prunedSessionsCount = await pruneOldFiles(oldSessionJsonlPaths, THIRTY_DAYS_MS);
+  const prunedDebugCount = await pruneOldFiles(debugFiles, THIRTY_DAYS_MS);
+  const prunedCount = prunedSessionsCount + prunedDebugCount;
+
+  console.log("[heartbeat] prune-old-sessions", {
+    prunedCount,
+    prunedSessionsCount,
+    prunedDebugCount,
+  });
+
+  return { prunedCount, prunedSessionsCount, prunedDebugCount };
+}
+
 export const heartbeatCron = inngest.createFunction(
   {
     id: "system-heartbeat",
   },
   [{ cron: "*/15 * * * *" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",
@@ -23,6 +107,8 @@
   },
   [{ event: "system/heartbeat.wake" }],
   async ({ step }) => {
+    await step.run("prune-old-sessions", pruneOldSessionFiles);
+
     await step.run("push-gateway-event", async () => {
       await pushGatewayEvent({
         type: "cron.heartbeat",

tokens used
28,792
